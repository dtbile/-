--[[
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘     ğŸ’€ è´´å§ç‹‚æš´Â·èŠå¤©è®°å½•å™¨Â·æŠ˜å ç‰ˆ v14.0 ğŸ’€                                â•‘
â•‘     æ–°åŠŸèƒ½ï¼š                                                               â•‘
â•‘     âœ… æ”¯æŒæŠ˜å  - åªæ˜¾ç¤ºé¡¶éƒ¨æ¨ªæ                                            â•‘
â•‘     âœ… ç‚¹å‡»æ¨ªæ ä»»æ„ä½ç½®å±•å¼€/æŠ˜å                                            â•‘
â•‘     âœ… æŠ˜å æ—¶æ˜¾ç¤ºç²¾ç®€ä¿¡æ¯ï¼ˆç‹‚æš´å€¼+è„è¯ç‡ï¼‰                                 â•‘
â•‘     âœ… æ‰‹æœºä¼˜åŒ–ï¼šåŠ å¤§ç‚¹å‡»åŒºåŸŸï¼Œé˜²è¯¯è§¦                                      â•‘
â•‘     å­—åº“åœ°å€ï¼šhttps://raw.githubusercontent.com/dtbile/-/refs/heads/main/words.txt â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
--]]

repeat wait() until game:GetService("Players").LocalPlayer

local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local localPlayer = Players.LocalPlayer
local playerGui = localPlayer:WaitForChild("PlayerGui")

-- ===== é…ç½® =====
local Config = {
    FileName = "è´´å§èŠå¤©è®°å½•.txt",
    BackupName = "èŠå¤©è®°å½•_" .. os.date("%Y%m%d") .. ".txt",
    MaxMessages = 1000,
    FontSize = 18,
    Vibrate = true,
    MinWidth = 300,
    MinHeight = 80,  -- æŠ˜å æ—¶æœ€å°é«˜åº¦
    MaxWidth = 800,
    MaxHeight = 1000,
    DefaultWidth = 420,
    DefaultHeight = 600,
    CollapsedHeight = 80,  -- æŠ˜å æ—¶é«˜åº¦
    SaveTimeout = 3,
    Colors = {
        Primary = Color3.fromRGB(255, 45, 85),
        Secondary = Color3.fromRGB(0, 255, 255),
        Accent = Color3.fromRGB(255, 215, 0),
        Background = Color3.fromRGB(5, 5, 15),
        Text = Color3.fromRGB(255, 255, 255),
        System = Color3.fromRGB(255, 215, 0),
    }
}

-- ===== å…¨å±€å˜é‡ =====
local chatHistory = {}
local messageStats = {}
local uiVisible = true
local isCollapsed = false  -- æŠ˜å çŠ¶æ€
local dragging = false
local resizing = false
local dragOffset = Vector2.new()
local resizeStart = Vector2.new()
local resizeStartSize = Vector2.new()
local currentFontSize = Config.FontSize
local currentWidth = Config.DefaultWidth
local currentHeight = Config.DefaultHeight
local glowIntensity = 0
local resizeHandleSize = 20
local messageCount = 0
local startTime = os.time()
local swearWordList = {}
local isSaving = false

-- ===== æš´èºç»Ÿè®¡ =====
local BaZhiStats = {
    swearMessages = 0,
    exclamationCount = 0,
    questionCount = 0,
    capsCount = 0,
    hashtagCount = 0,
    hashtagMessages = 0,
    totalMessages = 0,
}

-- ===== è¿œç¨‹åŠ è½½å­—åº“ =====
local function loadSwearWords()
    local url = "https://raw.githubusercontent.com/dtbile/-/refs/heads/main/words.txt"
    local success, data = pcall(function()
        return game:HttpGet(url)
    end)
    
    if not success or not data then
        warn("ğŸ’€ è”ç½‘å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°å¤‡ä»½è¯åº“")
        return {
            "è‰","é ","æ—¥","ç‰¹ä¹ˆ","å°¼ç›","SB","å‚»é€¼","åƒåœ¾","åºŸç‰©","æ»š",
            "æ“","è‚","è‰¹","å¦ˆ","çˆ¹","çˆ·","çˆ¬","æ€¼","æ·¦","ç‹—å±","ç‹—å±",
            "æ”¾å±","æ‰¯æ·¡","çæ‰¯","èƒ¡æ‰¯","èƒ¡è¯´","èƒ¡é—¹","æ¶å¿ƒ","å˜æ€",
            "ç•¸å½¢","å¥‡è‘©","æ²™é›•","é€—æ¯”","2B","250","ä½ å¦ˆ","ä½ å—","ä½ å¦¹",
            "ä½ ä¸«","éº»ç—¹","å¦ˆæ‰¹","å¦ˆå–æ‰¹","MLGB","NMSL","WQNMLGB"
        }
    end
    
    local success2, wordsTable = pcall(function()
        return loadstring(data)()
    end)
    
    if not success2 or not wordsTable then
        warn("ğŸ’€ å­—åº“åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°å¤‡ä»½")
        return {
            "è‰","é ","æ—¥","ç‰¹ä¹ˆ","å°¼ç›","SB","å‚»é€¼","åƒåœ¾","åºŸç‰©","æ»š",
            "æ“","è‚","è‰¹","å¦ˆ","çˆ¹","çˆ·","çˆ¬","æ€¼","æ·¦"
        }
    end
    
    local allWords = {}
    for category, wordList in pairs(wordsTable) do
        for _, word in ipairs(wordList) do
            table.insert(allWords, word)
        end
    end
    
    print(string.format("ğŸ’€ è¿œç¨‹å­—åº“åŠ è½½æˆåŠŸï¼å…± %d ä¸ªè¯", #allWords))
    return allWords
end

swearWordList = loadSwearWords()

-- ===== è·å–æ—¶é—´ =====
local function getTime()
    return os.date("%Y-%m-%d %H:%M:%S")
end

-- ===== ç‹¬ç«‹è¯æ±‡åŒ¹é… =====
local function isIndependentWord(message, word)
    if not word or word == "" then return false end
    
    if word == "#" then
        return message:find("#") ~= nil
    end
    
    local pattern = word:gsub("([%^$()%.%[%]*+%-?])", "%%%1")
    
    if word:match("^[a-zA-Z0-9]+$") then
        return message:find("%f[%a]" .. pattern .. "%f[%A]") ~= nil
    else
        local paddedMsg = " " .. message .. " "
        
        local function hasChineseAround(pos)
            local prevChar = paddedMsg:sub(pos-1, pos-1)
            local nextChar = paddedMsg:sub(pos + #word, pos + #word)
            
            if prevChar and prevChar:match("[\228-\233][\128-\191]+") then
                return true
            end
            if nextChar and nextChar:match("[\228-\233][\128-\191]+") then
                return true
            end
            return false
        end
        
        local startPos = 1
        while true do
            local pos = paddedMsg:find(pattern, startPos)
            if not pos then break end
            
            if not hasChineseAround(pos) then
                return true
            end
            
            startPos = pos + 1
        end
        
        return false
    end
end

-- ===== å¸¸è§è¯¯åˆ¤é»‘åå• =====
local falsePositiveList = {
    ["æ—¥"] = {"æ˜ŸæœŸæ—¥", "æ˜ŸæœŸä¸€", "æ˜ŸæœŸäºŒ", "æ˜ŸæœŸä¸‰", "æ˜ŸæœŸå››", "æ˜ŸæœŸäº”", "æ˜ŸæœŸå…­", 
              "æ—¥æœŸ", "æ—¥æœ¬", "æ—¥å¿—", "æ—¥å¸¸", "æ—¥ç¨‹", "æ—¥å†", "æ—¥å‡º", "æ—¥è½", "æ—¥å…‰",
              "æ—¥å­", "æ—¥æœˆ", "æ—¥å¤œ", "æ—¥ç›Š", "æ—¥å‡", "æ—¥äº§"},
    ["è‰"] = {"è‰åŸ", "è‰åœ°", "è‰åª", "è‰è“", "èŠ±è‰", "æ°´è‰", "èµ·è‰", "è‰ç¨¿", "è‰æ¡ˆ", "è‰ç‡",
              "è‰æ ¹", "è‰æœ¨", "è‰è¯", "è‰é‹", "è‰å¸½", "è‰å›¾", "è‰ä¹¦", "è‰ç»¿"},
    ["é "] = {"ä¾é ", "å¯é ", "é å±±", "é è¿‘", "é å²¸", "é èƒŒ", "é å«", "é æ‹¢", "é è¾¹", "é å¾—ä½"},
    ["å¦ˆ"] = {"å¦ˆå¦ˆ", "å¦ˆå’ª", "å§‘å¦ˆ", "å§¨å¦ˆ", "èˆ…å¦ˆ", "å¤§å¦ˆ", "é˜¿å¦ˆ", "å¦ˆç¥–"},
    ["çˆ·"] = {"çˆ·çˆ·", "è€çˆ·", "å¤§çˆ·", "å°‘çˆ·", "çˆ·ä»¬", "çˆ·å­™", "å§¥çˆ·", "å¸ˆçˆ·"},
    ["çˆ¹"] = {"çˆ¹çˆ¹", "è€çˆ¹", "å¹²çˆ¹", "çˆ¹åœ°", "çˆ¹å¨˜", "çˆ¹å¦ˆ"},
    ["SB"] = {"ASB", "BSB", "CSB", "DSB", "ESB", "FSB", "GSB", "HSB", "ISB", "JSB",
              "KSB", "LSB", "MSB", "NSB", "OSB", "PSB", "QSB", "RSB", "SSB", "TSB",
              "USB", "VSB", "WSB", "XSB", "YSB", "ZSB"},
}

-- ===== åˆ¤æ–­æ˜¯å¦ä¸ºè„è¯æ¶ˆæ¯ =====
local function isSwearMessage(message)
    local originalMsg = message
    
    if originalMsg:find("#") then
        return true, "hashtag"
    end
    
    for _, word in ipairs(swearWordList) do
        if originalMsg:find(word) then
            local blacklist = falsePositiveList[word]
            if blacklist then
                local inBlacklist = false
                for _, fp in ipairs(blacklist) do
                    if originalMsg:find(fp) then
                        inBlacklist = true
                        break
                    end
                end
                if inBlacklist then
                    if isIndependentWord(originalMsg, word) then
                        return true, word
                    end
                else
                    if isIndependentWord(originalMsg, word) then
                        return true, word
                    end
                end
            else
                if isIndependentWord(originalMsg, word) then
                    return true, word
                end
            end
        end
    end
    
    return false, nil
end

-- ===== åˆ†ææ¶ˆæ¯ =====
local function analyzeMessage(message)
    local originalMsg = message
    local upperMsg = message:upper()
    
    local _, exclamationCount = string.gsub(upperMsg, "!", "")
    BaZhiStats.exclamationCount = BaZhiStats.exclamationCount + exclamationCount
    
    local _, questionCount = string.gsub(upperMsg, "?", "")
    BaZhiStats.questionCount = BaZhiStats.questionCount + questionCount
    
    local capsCount = 0
    for char in upperMsg:gmatch(".") do
        if char:match("%u") then
            capsCount = capsCount + 1
        end
    end
    BaZhiStats.capsCount = BaZhiStats.capsCount + capsCount
    
    local _, hashtagTotal = string.gsub(originalMsg, "#", "")
    BaZhiStats.hashtagCount = BaZhiStats.hashtagCount + hashtagTotal
    
    local isSwear, swearWord = isSwearMessage(originalMsg)
    
    if isSwear then
        BaZhiStats.swearMessages = BaZhiStats.swearMessages + 1
        
        if swearWord == "hashtag" then
            BaZhiStats.hashtagMessages = BaZhiStats.hashtagMessages + 1
        end
    end
    
    BaZhiStats.totalMessages = BaZhiStats.totalMessages + 1
end

-- ===== è®¡ç®—è´´å§ç‹‚æš´å€¼ =====
local function calculateBaZhiIndex()
    if BaZhiStats.totalMessages < 3 then return 0 end
    
    local runtime = os.difftime(os.time(), startTime)
    if runtime < 30 then return 0 end
    
    local swearRate = BaZhiStats.swearMessages / BaZhiStats.totalMessages
    local swearScore = math.min(40, swearRate * 100)
    
    local msgPerMin = (BaZhiStats.totalMessages / runtime) * 60
    local frequencyScore = math.min(30, msgPerMin * 2)
    
    local symbolScore = 0
    if BaZhiStats.totalMessages > 0 then
        local avgExclamation = BaZhiStats.exclamationCount / BaZhiStats.totalMessages
        local avgQuestion = BaZhiStats.questionCount / BaZhiStats.totalMessages
        local avgHashtag = BaZhiStats.hashtagCount / BaZhiStats.totalMessages
        local avgCaps = BaZhiStats.capsCount / BaZhiStats.totalMessages
        
        symbolScore = math.min(30, 
            avgExclamation * 5 +
            avgQuestion * 3 +
            avgHashtag * 8 +
            avgCaps * 2
        )
    end
    
    return math.floor(math.min(100, swearScore + frequencyScore + symbolScore))
end

-- ===== è·å–è„è¯ç‡ =====
local function getSwearRate()
    if BaZhiStats.totalMessages == 0 then return 0 end
    return math.floor((BaZhiStats.swearMessages / BaZhiStats.totalMessages) * 100)
end

-- ===== ä¿å­˜æ–‡ä»¶ =====
local function saveToFileAsync(callback)
    if isSaving then
        if callback then callback(false, "æ­£åœ¨ä¿å­˜ä¸­") end
        return false
    end
    
    isSaving = true
    
    coroutine.wrap(function()
        local success = false
        local errorMsg = "æœªçŸ¥é”™è¯¯"
        
        local timeout = false
        local timer = coroutine.wrap(function()
            wait(Config.SaveTimeout)
            timeout = true
        end)
        timer()
        
        local saveSuccess, saveError = pcall(function()
            local content = "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n"
            content = content .. "â•‘ è´´å§ç‹‚æš´èŠå¤©è®°å½• " .. getTime() .. "                     â•‘\n"
            content = content .. "â•‘ ç©å®¶ï¼š" .. localPlayer.Name .. "\n"
            content = content .. "â•‘ å…± " .. #chatHistory .. " æ¡æ¶ˆæ¯\n"
            content = content .. "â•‘ è¿è¡Œæ—¶é—´ï¼š" .. os.difftime(os.time(), startTime) .. "ç§’\n"
            content = content .. "â•‘ è´´å§ç‹‚æš´å€¼ï¼š" .. calculateBaZhiIndex() .. "%\n"
            content = content .. "â•‘ è„è¯æ¶ˆæ¯ï¼š" .. BaZhiStats.swearMessages .. "æ¡\n"
            content = content .. "â•‘ è„è¯ç‡ï¼š" .. getSwearRate() .. "%\n"
            content = content .. "â•‘ #å·æ€»æ•°ï¼š" .. BaZhiStats.hashtagCount .. "ä¸ª\n"
            content = content .. "â•‘ å­—åº“è¯æ•°ï¼š" .. #swearWordList .. "ä¸ª\n"
            content = content .. "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n"
            
            for i = 1, #chatHistory do
                content = content .. chatHistory[i] .. "\n"
            end
            
            local paths = {
                Config.FileName,
                "/storage/emulated/0/" .. Config.FileName,
                "./" .. Config.FileName,
                "èŠå¤©è®°å½•_" .. os.date("%Y%m%d_%H%M%S") .. ".txt",
            }
            
            for _, path in ipairs(paths) do
                pcall(function() writefile(path, content) end)
            end
        end)
        
        if timeout then
            errorMsg = "ä¿å­˜è¶…æ—¶"
        elseif saveSuccess then
            success = true
        else
            errorMsg = tostring(saveError)
        end
        
        isSaving = false
        if callback then callback(success, errorMsg) end
    end)()
    
    return true
end

-- ===== ä¿å­˜æ–‡ä»¶ =====
local function saveToFile()
    return saveToFileAsync()
end

-- ===== è‡ªåŠ¨æ¢è¡Œæ–‡æœ¬ =====
local function createWrappedText(parent, text, textColor, fontSize)
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, -10, 0, 0)
    label.BackgroundTransparency = 1
    label.Text = text
    label.TextColor3 = textColor
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.TextYAlignment = Enum.TextYAlignment.Top
    label.TextSize = fontSize
    label.Font = Enum.Font.SourceSans
    label.RichText = true
    label.TextWrapped = true
    label.AutomaticSize = Enum.AutomaticSize.Y
    label.Parent = parent
    return label
end

-- ===== åˆ‡æ¢æŠ˜å çŠ¶æ€ =====
local function toggleCollapse(mainFrame, scrollFrame, buttonGrid, countLabel, resizeHandle)
    isCollapsed = not isCollapsed
    
    if isCollapsed then
        -- æŠ˜å ï¼šåªæ˜¾ç¤ºæ ‡é¢˜æ 
        mainFrame.Size = UDim2.new(0, currentWidth, 0, Config.CollapsedHeight)
        scrollFrame.Visible = false
        buttonGrid.Visible = false
        countLabel.Visible = false
        resizeHandle.Visible = false
    else
        -- å±•å¼€ï¼šæ˜¾ç¤ºå…¨éƒ¨
        mainFrame.Size = UDim2.new(0, currentWidth, 0, currentHeight)
        scrollFrame.Visible = true
        buttonGrid.Visible = true
        countLabel.Visible = true
        resizeHandle.Visible = true
    end
    
    pcall(function() game:GetService("VibrationService"):Vibrate("Light") end)
end

-- ===== æ›´æ–°UIæ˜¾ç¤º =====
local function updateUIDisplay(mainFrame, countLabel)
    if not countLabel then return end
    
    if isCollapsed then
        -- æŠ˜å æ—¶æ˜¾ç¤ºç²¾ç®€ä¿¡æ¯
        local baZhi = calculateBaZhiIndex()
        local swearRate = getSwearRate()
        countLabel.Text = string.format("ğŸ’€ %d%% | ğŸ¤¬ %d%% | ğŸ“š %dè¯", 
            baZhi, swearRate, #swearWordList)
        countLabel.Visible = true
        countLabel.Position = UDim2.new(0, 100, 0, 15)  -- ç§»åˆ°æ ‡é¢˜æ å³è¾¹
    else
        -- å±•å¼€æ—¶æ˜¾ç¤ºå®Œæ•´ä¿¡æ¯
        countLabel.Text = string.format("ğŸ“Š %dæ¡ | ğŸ‘¥ %däºº | ğŸ’€ %d%% | ğŸ¤¬ %d%% | ğŸ“š %dè¯", 
            messageCount, 
            #Players:GetPlayers(), 
            calculateBaZhiIndex(),
            getSwearRate(),
            #swearWordList)
        countLabel.Position = UDim2.new(0, 10, 1, -25)  -- æ”¾å›åº•éƒ¨
    end
end

-- ===== æ·»åŠ æ¶ˆæ¯ï¼ˆæ›´æ–°æŠ˜å æ˜¾ç¤ºï¼‰=====
local function addMessage(text, isSystem)
    local fullMsg = "[" .. getTime() .. "] " .. text
    table.insert(chatHistory, fullMsg)
    
    if not isSystem then
        analyzeMessage(text)
        
        local speaker = string.match(text, "^(.-)ï¼š")
        if speaker and speaker ~= "ç³»ç»Ÿ" and speaker ~= "æˆ‘" then
            for _, player in ipairs(Players:GetPlayers()) do
                if player.Name == speaker and player ~= localPlayer then
                    messageStats[speaker] = (messageStats[speaker] or 0) + 1
                    break
                end
            end
        end
        messageCount = messageCount + 1
    end
    
    if #chatHistory > Config.MaxMessages then
        table.remove(chatHistory, 1)
    end
    
    -- æ›´æ–°UI
    local gui = playerGui:FindFirstChild("ChatLoggerGUI")
    if gui then
        local mainFrame = gui:FindFirstChild("MainFrame")
        if not mainFrame then return end
        
        local scrollFrame = mainFrame:FindFirstChild("ScrollingFrame")
        local countLabel = mainFrame:FindFirstChild("CountLabel")
        
        if scrollFrame and not isCollapsed then
            local label = createWrappedText(scrollFrame, fullMsg, 
                isSystem and Config.Colors.System or Config.Colors.Text, 
                currentFontSize)
            
            local yPos = 0
            for i, child in ipairs(scrollFrame:GetChildren()) do
                if child:IsA("TextLabel") then
                    child.Position = UDim2.new(0, 5, 0, yPos)
                    yPos = yPos + child.AbsoluteSize.Y + 2
                end
            end
            
            scrollFrame.CanvasSize = UDim2.new(0, 0, 0, yPos)
            scrollFrame.CanvasPosition = Vector2.new(0, scrollFrame.CanvasSize.Y.Offset)
        end
        
        if countLabel then
            updateUIDisplay(mainFrame, countLabel)
        end
    end
    
    if not isSystem and Config.Vibrate then
        pcall(function() game:GetService("VibrationService"):Vibrate("Light") end)
    end
end

-- ===== æ˜¾ç¤ºè¯¦ç»†ç»Ÿè®¡ =====
local function showDetailedStats()
    local runtime = os.difftime(os.time(), startTime)
    local baZhi = calculateBaZhiIndex()
    local swearRate = getSwearRate()
    
    addMessage("ğŸ“Š ç³»ç»Ÿï¼šâ•â•â•â•â• å®æ—¶ç»Ÿè®¡ â•â•â•â•â•", true)
    addMessage("ğŸ“Š ç³»ç»Ÿï¼šæ€»æ¶ˆæ¯æ•°ï¼š" .. BaZhiStats.totalMessages .. "æ¡", true)
    addMessage("ğŸ“Š ç³»ç»Ÿï¼šåœ¨çº¿äººæ•°ï¼š" .. #Players:GetPlayers() .. "äºº", true)
    addMessage("ğŸ“Š ç³»ç»Ÿï¼šè¿è¡Œæ—¶é—´ï¼š" .. math.floor(runtime/60) .. "åˆ†é’Ÿ", true)
    addMessage("ğŸ“Š ç³»ç»Ÿï¼šæ¶ˆæ¯é¢‘ç‡ï¼š" .. (runtime>0 and math.floor((BaZhiStats.totalMessages/runtime)*60) or 0) .. "æ¡/åˆ†é’Ÿ", true)
    addMessage("ğŸ“Š ç³»ç»Ÿï¼šå­—åº“è¯æ•°ï¼š" .. #swearWordList .. "ä¸ª", true)
    
    addMessage("ğŸ“Š ç³»ç»Ÿï¼šâ•â•â•â• æš´èºåˆ†æ â•â•â•â•", true)
    addMessage("ğŸ“Š ç³»ç»Ÿï¼šğŸ’¢ æ„Ÿå¹å·æ€»æ•°ï¼š" .. BaZhiStats.exclamationCount .. "ä¸ª", true)
    addMessage("ğŸ“Š ç³»ç»Ÿï¼šâ“ é—®å·æ€»æ•°ï¼š" .. BaZhiStats.questionCount .. "ä¸ª", true)
    addMessage("ğŸ“Š ç³»ç»Ÿï¼šğŸ”Š å¤§å†™å­—æ¯ï¼š" .. BaZhiStats.capsCount .. "ä¸ª", true)
    addMessage("ğŸ“Š ç³»ç»Ÿï¼š#ï¸âƒ£ #å·æ€»æ•°ï¼š" .. BaZhiStats.hashtagCount .. "ä¸ª", true)
    addMessage("ğŸ“Š ç³»ç»Ÿï¼šğŸ“Œ å¸¦#å·æ¶ˆæ¯ï¼š" .. BaZhiStats.hashtagMessages .. "æ¡", true)
    addMessage("ğŸ“Š ç³»ç»Ÿï¼šğŸ¤¬ è„è¯æ¶ˆæ¯ï¼š" .. BaZhiStats.swearMessages .. "æ¡", true)
    addMessage("ğŸ“Š ç³»ç»Ÿï¼šğŸ“ˆ è„è¯ç‡ï¼š" .. swearRate .. "%", true)
    
    if BaZhiStats.totalMessages > 0 then
        addMessage("ğŸ“Š ç³»ç»Ÿï¼šâ•â•â•â• å¹³å‡æŒ‡æ ‡ â•â•â•â•", true)
        addMessage("ğŸ“Š ç³»ç»Ÿï¼šå¹³å‡æ„Ÿå¹å·ï¼š" .. string.format("%.1f", BaZhiStats.exclamationCount/BaZhiStats.totalMessages) .. "ä¸ª/æ¡", true)
        addMessage("ğŸ“Š ç³»ç»Ÿï¼šå¹³å‡#å·ï¼š" .. string.format("%.1f", BaZhiStats.hashtagCount/BaZhiStats.totalMessages) .. "ä¸ª/æ¡", true)
    end
    
    addMessage("ğŸ“Š ç³»ç»Ÿï¼šâ•â•â•â• ç©å®¶ç»Ÿè®¡ â•â•â•â•", true)
    local sortedStats = {}
    for name, count in pairs(messageStats) do
        table.insert(sortedStats, {name = name, count = count})
    end
    table.sort(sortedStats, function(a, b) return a.count > b.count end)
    
    for i, data in ipairs(sortedStats) do
        local percentage = BaZhiStats.totalMessages>0 and math.floor((data.count/BaZhiStats.totalMessages)*100) or 0
        addMessage(string.format("ğŸ“Š ç³»ç»Ÿï¼š%d. %sï¼š%dæ¡ (%d%%)", i, data.name, data.count, percentage), true)
    end
    
    addMessage("ğŸ“Š ç³»ç»Ÿï¼šâ•â•â•â• æš´èºæŒ‡æ•° â•â•â•â•", true)
    addMessage("ğŸ“Š ç³»ç»Ÿï¼šğŸ’€ è´´å§ç‹‚æš´å€¼ï¼š" .. baZhi .. "%", true)
    
    local bar = ""
    for i = 1, 20 do
        bar = bar .. (i <= math.floor(baZhi/5) and "â–ˆ" or "â–‘")
    end
    addMessage("ğŸ“Š ç³»ç»Ÿï¼š" .. bar, true)
    
    local comment = baZhi < 20 and "ğŸ•Šï¸ å’Œå¹³é¸½æ¨¡å¼" or 
                    baZhi < 40 and "ğŸ˜ æ­£å¸¸äº¤æµ" or 
                    baZhi < 60 and "ğŸ˜¤ æœ‰ç‚¹æš´èº" or 
                    baZhi < 80 and "ğŸ¤¬ è´´å§è€å“¥é™„ä½“" or 
                    "ğŸ’€ ç‹‚æš´æ¨¡å¼Â·MAX"
    addMessage("ğŸ“Š ç³»ç»Ÿï¼šè¯„ä»·ï¼š" .. comment, true)
end

-- ===== åˆ›å»ºUIï¼ˆæŠ˜å ç‰ˆï¼‰=====
local function createUI()
    local old = playerGui:FindFirstChild("ChatLoggerGUI")
    if old then old:Destroy() end
    
    local gui = Instance.new("ScreenGui")
    gui.Name = "ChatLoggerGUI"
    gui.ResetOnSpawn = false
    gui.Parent = playerGui
    
    -- ä¸»æ¡†æ¶
    local mainFrame = Instance.new("Frame")
    mainFrame.Name = "MainFrame"
    mainFrame.Size = UDim2.new(0, currentWidth, 0, currentHeight)
    mainFrame.Position = UDim2.new(1, -currentWidth - 10, 1, -currentHeight - 10)
    mainFrame.BackgroundColor3 = Config.Colors.Background
    mainFrame.BackgroundTransparency = 0.1
    mainFrame.BorderSizePixel = 0
    mainFrame.ClipsDescendants = true
    mainFrame.Active = true
    mainFrame.Parent = gui
    
    -- æ¯›ç»ç’ƒ
    local glassEffect = Instance.new("Frame")
    glassEffect.Size = UDim2.new(1, 0, 1, 0)
    glassEffect.BackgroundColor3 = Color3.new(1, 1, 1)
    glassEffect.BackgroundTransparency = 0.95
    glassEffect.BorderSizePixel = 0
    glassEffect.Parent = mainFrame
    
    -- éœ“è™¹è¾¹æ¡†
    local border = Instance.new("Frame")
    border.Size = UDim2.new(1, 0, 1, 0)
    border.BackgroundTransparency = 1
    border.BorderSizePixel = 3
    border.BorderColor3 = Config.Colors.Primary
    border.Parent = mainFrame
    
    -- åŠ¨æ€å…‰æ™•
    local glow = Instance.new("Frame")
    glow.Size = UDim2.new(1, 10, 1, 10)
    glow.Position = UDim2.new(0, -5, 0, -5)
    glow.BackgroundColor3 = Config.Colors.Primary
    glow.BackgroundTransparency = 0.9
    glow.BorderSizePixel = 0
    glow.Parent = mainFrame
    
    -- ===== æ ‡é¢˜æ ï¼ˆå¯ç‚¹å‡»æŠ˜å ï¼‰=====
    local titleBar = Instance.new("Frame")
    titleBar.Name = "TitleBar"
    titleBar.Size = UDim2.new(1, 0, 0, 50)
    titleBar.BackgroundColor3 = Config.Colors.Primary
    titleBar.BackgroundTransparency = 0.2
    titleBar.BorderSizePixel = 0
    titleBar.Parent = mainFrame
    
    -- æ ‡é¢˜æ–‡å­—
    local title = Instance.new("TextLabel")
    title.Size = UDim2.new(1, -100, 1, 0)
    title.Position = UDim2.new(0, 15, 0, 0)
    title.BackgroundTransparency = 1
    title.Text = "ğŸ’€ è´´å§ç‹‚æš´è®°å½•å™¨ v14.0 ğŸ’€"
    title.TextColor3 = Color3.new(1, 1, 1)
    title.TextSize = currentFontSize + 4
    title.TextXAlignment = Enum.TextXAlignment.Left
    title.Font = Enum.Font.GothamBold
    title.Parent = titleBar
    
    -- éšè—æŒ‰é’®
    local hideButton = Instance.new("TextButton")
    hideButton.Size = UDim2.new(0, 40, 0, 40)
    hideButton.Position = UDim2.new(1, -45, 0, 5)
    hideButton.BackgroundColor3 = Config.Colors.Accent
    hideButton.BackgroundTransparency = 0.3
    hideButton.Text = "âœ–"
    hideButton.TextColor3 = Color3.new(0, 0, 0)
    hideButton.TextSize = currentFontSize + 8
    hideButton.Font = Enum.Font.GothamBold
    hideButton.Parent = titleBar
    
    -- æŠ˜å æŒ‡ç¤ºå™¨
    local collapseIcon = Instance.new("TextLabel")
    collapseIcon.Size = UDim2.new(0, 30, 0, 30)
    collapseIcon.Position = UDim2.new(1, -80, 0, 10)
    collapseIcon.BackgroundTransparency = 1
    collapseIcon.Text = "â–¼"
    collapseIcon.TextColor3 = Color3.new(1, 1, 1)
    collapseIcon.TextSize = currentFontSize + 2
    collapseIcon.Font = Enum.Font.GothamBold
    collapseIcon.Parent = titleBar
    
    -- èŠå¤©åŒºåŸŸ
    local scrollFrame = Instance.new("ScrollingFrame")
    scrollFrame.Name = "ScrollingFrame"
    scrollFrame.Size = UDim2.new(1, -20, 1, -140)
    scrollFrame.Position = UDim2.new(0, 10, 0, 60)
    scrollFrame.BackgroundColor3 = Color3.new(0, 0, 0)
    scrollFrame.BackgroundTransparency = 0.5
    scrollFrame.BorderSizePixel = 0
    scrollFrame.ScrollBarThickness = 8
    scrollFrame.ScrollBarImageColor3 = Config.Colors.Secondary
    scrollFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
    scrollFrame.AutomaticCanvasSize = Enum.AutomaticSize.Y
    scrollFrame.Parent = mainFrame
    
    -- æŒ‰é’®åŒºåŸŸ
    local buttonGrid = Instance.new("Frame")
    buttonGrid.Size = UDim2.new(1, -20, 0, 80)
    buttonGrid.Position = UDim2.new(0, 10, 1, -90)
    buttonGrid.BackgroundTransparency = 1
    buttonGrid.Parent = mainFrame
    
    -- åˆ›å»ºæŒ‰é’®å‡½æ•°
    local function createButton(x, y, color, text, width)
        local btn = Instance.new("TextButton")
        btn.Size = UDim2.new(0, width or 70, 0, 35)
        btn.Position = UDim2.new(0, x, 0, y)
        btn.BackgroundColor3 = color
        btn.BackgroundTransparency = 0.2
        btn.Text = text
        btn.TextColor3 = Color3.new(1, 1, 1)
        btn.TextSize = currentFontSize - 2
        btn.Font = Enum.Font.GothamBold
        btn.Parent = buttonGrid
        
        btn.MouseEnter:Connect(function()
            TweenService:Create(btn, TweenInfo.new(0.2), {BackgroundTransparency = 0}):Play()
            btn.TextSize = currentFontSize
        end)
        
        btn.MouseLeave:Connect(function()
            TweenService:Create(btn, TweenInfo.new(0.2), {BackgroundTransparency = 0.2}):Play()
            btn.TextSize = currentFontSize - 2
        end)
        
        return btn
    end
    
    -- ç¬¬ä¸€æ’
    local saveBtn = createButton(0, 0, Color3.fromRGB(0, 200, 0), "ğŸ’¾ä¿å­˜")
    local clearBtn = createButton(80, 0, Color3.fromRGB(255, 100, 0), "ğŸ—‘ï¸æ¸…ç©º")
    local exportBtn = createButton(160, 0, Color3.fromRGB(0, 150, 255), "ğŸ“¤å¯¼å‡º")
    local statsBtn = createButton(240, 0, Color3.fromRGB(150, 0, 255), "ğŸ“Šç»Ÿè®¡")
    
    -- ç¬¬äºŒæ’
    local fontBtn = createButton(0, 40, Color3.fromRGB(100, 100, 100), "ğŸ”¤å­—ä½“", 60)
    local copyBtn = createButton(70, 40, Color3.fromRGB(100, 100, 100), "ğŸ“‹å¤åˆ¶", 60)
    local themeBtn = createButton(140, 40, Color3.fromRGB(200, 0, 200), "ğŸ¨ä¸»é¢˜", 60)
    local resizeBtn = createButton(210, 40, Color3.fromRGB(0, 200, 200), "ğŸ“å¤§å°", 60)
    local closeBtn = createButton(280, 40, Color3.fromRGB(255, 0, 0), "â»å…³é—­", 60)
    
    -- å³ä¸‹è§’è°ƒæ•´æ‰‹æŸ„
    local resizeHandle = Instance.new("Frame")
    resizeHandle.Name = "ResizeHandle"
    resizeHandle.Size = UDim2.new(0, resizeHandleSize, 0, resizeHandleSize)
    resizeHandle.Position = UDim2.new(1, -resizeHandleSize, 1, -resizeHandleSize)
    resizeHandle.BackgroundColor3 = Config.Colors.Secondary
    resizeHandle.BackgroundTransparency = 0.5
    resizeHandle.BorderSizePixel = 0
    resizeHandle.Parent = mainFrame
    
    -- ä¿¡æ¯æ ‡ç­¾ï¼ˆæŠ˜å æ—¶ä¼šç§»åŠ¨åˆ°æ ‡é¢˜æ ï¼‰
    local countLabel = Instance.new("TextLabel")
    countLabel.Name = "CountLabel"
    countLabel.Size = UDim2.new(1, -20, 0, 20)
    countLabel.Position = UDim2.new(0, 10, 1, -25)
    countLabel.BackgroundTransparency = 1
    countLabel.Text = string.format("ğŸ“Š 0æ¡ | ğŸ‘¥ 0äºº | ğŸ’€ 0%% | ğŸ¤¬ 0%% | ğŸ“š %dè¯", #swearWordList)
    countLabel.TextColor3 = Config.Colors.Secondary
    countLabel.TextSize = currentFontSize - 4
    countLabel.TextXAlignment = Enum.TextXAlignment.Left
    countLabel.Font = Enum.Font.SourceSansBold
    countLabel.Parent = mainFrame
    
    -- ===== æ‹–æ‹½åŠŸèƒ½ï¼ˆåªåœ¨æ ‡é¢˜æ ï¼‰=====
    titleBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.Touch or 
           input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragOffset = Vector2.new(input.Position.X - mainFrame.AbsolutePosition.X, 
                                     input.Position.Y - mainFrame.AbsolutePosition.Y)
            titleBar.BackgroundTransparency = 0
        end
    end)
    
    titleBar.InputChanged:Connect(function(input)
        if dragging and (input.UserInputType == Enum.UserInputType.Touch or 
                        input.UserInputType == Enum.UserInputType.MouseMovement) then
            local newPos = Vector2.new(input.Position.X - dragOffset.X, 
                                       input.Position.Y - dragOffset.Y)
            mainFrame.Position = UDim2.new(0, newPos.X, 0, newPos.Y)
        end
    end)
    
    titleBar.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.Touch or 
           input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
            titleBar.BackgroundTransparency = 0.2
        end
    end)
    
    -- ===== æŠ˜å åŠŸèƒ½ï¼ˆç‚¹å‡»æ ‡é¢˜æ ä»»æ„ä½ç½®ï¼‰=====
    titleBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.Touch or 
           input.UserInputType == Enum.UserInputType.MouseButton1 then
            -- å»¶è¿Ÿä¸€ç‚¹ï¼Œé¿å…å’Œæ‹–æ‹½å†²çª
            wait(0.1)
            if not dragging then
                toggleCollapse(mainFrame, scrollFrame, buttonGrid, countLabel, resizeHandle)
                collapseIcon.Text = isCollapsed and "â–²" or "â–¼"
                updateUIDisplay(mainFrame, countLabel)
            end
        end
    end)
    
    -- ===== è°ƒæ•´å¤§å°åŠŸèƒ½ï¼ˆæŠ˜å æ—¶ä¸å¯ç”¨ï¼‰=====
    resizeHandle.InputBegan:Connect(function(input)
        if isCollapsed then return end
        if input.UserInputType == Enum.UserInputType.Touch or 
           input.UserInputType == Enum.UserInputType.MouseButton1 then
            resizing = true
            resizeStart = Vector2.new(input.Position.X, input.Position.Y)
            resizeStartSize = Vector2.new(mainFrame.AbsoluteSize.X, mainFrame.AbsoluteSize.Y)
            resizeHandle.BackgroundTransparency = 0
        end
    end)
    
    resizeHandle.InputChanged:Connect(function(input)
        if not resizing or isCollapsed then return end
        if input.UserInputType == Enum.UserInputType.Touch or 
           input.UserInputType == Enum.UserInputType.MouseMovement then
            local delta = Vector2.new(input.Position.X - resizeStart.X, 
                                      input.Position.Y - resizeStart.Y)
            local newWidth = math.clamp(resizeStartSize.X + delta.X, Config.MinWidth, Config.MaxWidth)
            local newHeight = math.clamp(resizeStartSize.Y + delta.Y, Config.MinHeight, Config.MaxHeight)
            
            mainFrame.Size = UDim2.new(0, newWidth, 0, newHeight)
            currentWidth = newWidth
            currentHeight = newHeight
        end
    end)
    
    resizeHandle.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.Touch or 
           input.UserInputType == Enum.UserInputType.MouseButton1 then
            resizing = false
            resizeHandle.BackgroundTransparency = 0.5
        end
    end)
    
    -- åŠ¨æ€å…‰æ•ˆ
    RunService.Heartbeat:Connect(function()
        glowIntensity = (glowIntensity + 0.02) % (math.pi * 2)
        local alpha = 0.85 + math.sin(glowIntensity) * 0.1
        glow.BackgroundTransparency = alpha
        border.BorderColor3 = Color3.new(
            Config.Colors.Primary.r * (0.8 + math.sin(glowIntensity) * 0.2),
            Config.Colors.Primary.g * (0.8 + math.sin(glowIntensity) * 0.2),
            Config.Colors.Primary.b * (0.8 + math.sin(glowIntensity) * 0.2)
        )
    end)
    
    -- ===== æŒ‰é’®åŠŸèƒ½ =====
    hideButton.MouseButton1Click:Connect(function()
        uiVisible = not uiVisible
        mainFrame.Visible = uiVisible
        hideButton.Text = uiVisible and "âœ–" or "â—‰"
        pcall(function() game:GetService("VibrationService"):Vibrate("Light") end)
    end)
    
    saveBtn.MouseButton1Click:Connect(function()
        if isCollapsed then toggleCollapse(mainFrame, scrollFrame, buttonGrid, countLabel, resizeHandle) end
        pcall(function() game:GetService("VibrationService"):Vibrate("Light") end)
        
        if isSaving then
            addMessage("ğŸ’¾ ç³»ç»Ÿï¼šæ­£åœ¨ä¿å­˜ä¸­...", true)
            return
        end
        
        saveBtn.Text = "â³..."
        saveBtn.BackgroundColor3 = Color3.fromRGB(255, 165, 0)
        
        saveToFileAsync(function(success, errorMsg)
            if success then
                saveBtn.Text = "âœ…"
                saveBtn.BackgroundColor3 = Color3.fromRGB(0, 200, 0)
                addMessage("ğŸ’¾ ç³»ç»Ÿï¼šä¿å­˜æˆåŠŸï¼", true)
            else
                saveBtn.Text = "âŒ"
                saveBtn.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
                addMessage("ğŸ’¾ ç³»ç»Ÿï¼šä¿å­˜å¤±è´¥ - " .. (errorMsg or "æœªçŸ¥é”™è¯¯"), true)
            end
            
            wait(1.5)
            saveBtn.Text = "ğŸ’¾ä¿å­˜"
            saveBtn.BackgroundColor3 = Color3.fromRGB(0, 200, 0)
        end)
    end)
    
    clearBtn.MouseButton1Click:Connect(function()
        if isCollapsed then toggleCollapse(mainFrame, scrollFrame, buttonGrid, countLabel, resizeHandle) end
        chatHistory = {}
        messageStats = {}
        messageCount = 0
        BaZhiStats = {
            swearMessages = 0,
            exclamationCount = 0,
            questionCount = 0,
            capsCount = 0,
            hashtagCount = 0,
            hashtagMessages = 0,
            totalMessages = 0,
        }
        scrollFrame:ClearAllChildren()
        scrollFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
        addMessage("ğŸ—‘ï¸ ç³»ç»Ÿï¼šèŠå¤©è®°å½•å·²æ¸…ç©º", true)
        pcall(function() game:GetService("VibrationService"):Vibrate("Light") end)
    end)
    
    exportBtn.MouseButton1Click:Connect(function()
        if isCollapsed then toggleCollapse(mainFrame, scrollFrame, buttonGrid, countLabel, resizeHandle) end
        pcall(function() game:GetService("VibrationService"):Vibrate("Light") end)
        
        if isSaving then
            addMessage("ğŸ“¤ ç³»ç»Ÿï¼šæ­£åœ¨å¯¼å‡ºä¸­...", true)
            return
        end
        
        exportBtn.Text = "â³..."
        exportBtn.BackgroundColor3 = Color3.fromRGB(255, 165, 0)
        
        saveToFileAsync(function(success, errorMsg)
            if success then
                exportBtn.Text = "âœ…"
                exportBtn.BackgroundColor3 = Color3.fromRGB(0, 150, 255)
                addMessage("ğŸ“¤ ç³»ç»Ÿï¼šå¯¼å‡ºæˆåŠŸï¼", true)
                pcall(function() 
                    setclipboard("æ–‡ä»¶å·²ä¿å­˜ï¼š" .. Config.FileName)
                end)
            else
                exportBtn.Text = "âŒ"
                exportBtn.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
                addMessage("ğŸ“¤ ç³»ç»Ÿï¼šå¯¼å‡ºå¤±è´¥ - " .. (errorMsg or "æœªçŸ¥é”™è¯¯"), true)
            end
            
            wait(1.5)
            exportBtn.Text = "ğŸ“¤å¯¼å‡º"
            exportBtn.BackgroundColor3 = Color3.fromRGB(0, 150, 255)
        end)
    end)
    
    statsBtn.MouseButton1Click:Connect(function()
        if isCollapsed then toggleCollapse(mainFrame, scrollFrame, buttonGrid, countLabel, resizeHandle) end
        showDetailedStats()
        pcall(function() game:GetService("VibrationService"):Vibrate("Light") end)
    end)
    
    fontBtn.MouseButton1Click:Connect(function()
        if isCollapsed then toggleCollapse(mainFrame, scrollFrame, buttonGrid, countLabel, resizeHandle) end
        local sizes = {14, 18, 22, 26}
        local currentIndex = 1
        for i, size in ipairs(sizes) do
            if currentFontSize == size then
                currentIndex = i
                break
            end
        end
        currentFontSize = sizes[currentIndex % #sizes + 1]
        addMessage("ğŸ”¤ ç³»ç»Ÿï¼šå­—ä½“å¤§å° = " .. currentFontSize, true)
        pcall(function() game:GetService("VibrationService"):Vibrate("Light") end)
    end)
    
    copyBtn.MouseButton1Click:Connect(function()
        if isCollapsed then toggleCollapse(mainFrame, scrollFrame, buttonGrid, countLabel, resizeHandle) end
        local allText = table.concat(chatHistory, "\n")
        pcall(function()
            setclipboard(allText)
            addMessage("ğŸ“‹ ç³»ç»Ÿï¼šå·²å¤åˆ¶åˆ°å‰ªè´´æ¿ (" .. #chatHistory .. "æ¡)", true)
        end)
        pcall(function() game:GetService("VibrationService"):Vibrate("Light") end)
    end)
    
    -- ä¸»é¢˜åˆ‡æ¢
    local themeIndex = 1
    local themes = {
        {Primary = Color3.fromRGB(255, 45, 85), Secondary = Color3.fromRGB(0, 255, 255), Name = "éœ“è™¹ç²‰"},
        {Primary = Color3.fromRGB(0, 255, 0), Secondary = Color3.fromRGB(255, 0, 255), Name = "èµ›åšç»¿"},
        {Primary = Color3.fromRGB(255, 200, 0), Secondary = Color3.fromRGB(0, 200, 255), Name = "åœŸè±ªé‡‘"},
        {Primary = Color3.fromRGB(150, 0, 255), Secondary = Color3.fromRGB(0, 255, 150), Name = "ç´«ç½—å…°"},
    }
    
    themeBtn.MouseButton1Click:Connect(function()
        if isCollapsed then toggleCollapse(mainFrame, scrollFrame, buttonGrid, countLabel, resizeHandle) end
        themeIndex = themeIndex % #themes + 1
        Config.Colors.Primary = themes[themeIndex].Primary
        Config.Colors.Secondary = themes[themeIndex].Secondary
        
        titleBar.BackgroundColor3 = Config.Colors.Primary
        border.BorderColor3 = Config.Colors.Primary
        scrollFrame.ScrollBarImageColor3 = Config.Colors.Secondary
        resizeHandle.BackgroundColor3 = Config.Colors.Secondary
        
        addMessage("ğŸ¨ ç³»ç»Ÿï¼šä¸»é¢˜å·²åˆ‡æ¢ä¸º " .. themes[themeIndex].Name, true)
        pcall(function() game:GetService("VibrationService"):Vibrate("Light") end)
    end)
    
    -- é¢„è®¾å¤§å°
    local sizes = {{420,600}, {500,700}, {600,800}, {350,500}}
    local sizeIndex = 1
    
    resizeBtn.MouseButton1Click:Connect(function()
        if isCollapsed then toggleCollapse(mainFrame, scrollFrame, buttonGrid, countLabel, resizeHandle) end
        sizeIndex = sizeIndex % #sizes + 1
        currentWidth = sizes[sizeIndex][1]
        currentHeight = sizes[sizeIndex][2]
        mainFrame.Size = UDim2.new(0, currentWidth, 0, currentHeight)
        addMessage("ğŸ“ ç³»ç»Ÿï¼šç•Œé¢å¤§å°é¢„è®¾ " .. currentWidth .. "x" .. currentHeight, true)
        pcall(function() game:GetService("VibrationService"):Vibrate("Light") end)
    end)
    
    closeBtn.MouseButton1Click:Connect(function()
        gui:Destroy()
        print("ğŸ’€ UIå·²å…³é—­ï¼Œåå°æŒç»­è®°å½•ä¸­...")
        pcall(function() game:GetService("VibrationService"):Vibrate("Light") end)
    end)
    
    -- å¯åŠ¨æ¶ˆæ¯
    addMessage("ğŸ’€ ç³»ç»Ÿï¼šè´´å§ç‹‚æš´è®°å½•å™¨ v14.0", true)
    addMessage("ğŸ’€ ç³»ç»Ÿï¼šæŠ˜å ç‰ˆ - ç‚¹å‡»æ¨ªæ å±•å¼€/æŠ˜å ", true)
    addMessage("ğŸ’€ ç³»ç»Ÿï¼šæ–‡ä»¶å = " .. Config.FileName, true)
    addMessage("ğŸ’€ ç³»ç»Ÿï¼šå­—åº“è¯æ•° = " .. #swearWordList .. "ä¸ª", true)
end

-- ===== ç›‘å¬èŠå¤© =====
local function setupChatListener()
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= localPlayer then
            player.Chatted:Connect(function(msg) addMessage(player.Name .. "ï¼š " .. msg) end)
        end
    end
    
    Players.PlayerAdded:Connect(function(player)
        player.Chatted:Connect(function(msg) addMessage(player.Name .. "ï¼š " .. msg) end)
        addMessage("ğŸšª ç³»ç»Ÿï¼š" .. player.Name .. " åŠ å…¥äº†æ¸¸æˆ", true)
    end)
    
    Players.PlayerRemoving:Connect(function(player)
        addMessage("ğŸšª ç³»ç»Ÿï¼š" .. player.Name .. " ç¦»å¼€äº†æ¸¸æˆ", true)
    end)
    
    if localPlayer then
        localPlayer.Chatted:Connect(function(msg) 
            addMessage("æˆ‘ï¼š " .. msg)
        end)
    end
end

-- ===== è‡ªåŠ¨ä¿å­˜ =====
coroutine.wrap(function()
    while true do
        wait(180)
        if #chatHistory > 0 and not isSaving then
            saveToFileAsync(function(success)
                if success then
                    print("ğŸ’€ è‡ªåŠ¨ä¿å­˜å®Œæˆï¼Œç‹‚æš´å€¼ï¼š" .. calculateBaZhiIndex() .. "%")
                end
            end)
        end
    end
end)()

-- ===== å¯åŠ¨ï¼ =====
createUI()
setupChatListener()

print("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
print("â•‘     ğŸ’€ å¯åŠ¨æˆåŠŸï¼æŠ˜å ç‰ˆ v14.0ï¼ ğŸ’€                          â•‘")
print("â•‘    æ–°åŠŸèƒ½ï¼š                                                  â•‘")
print("â•‘    âœ… ç‚¹å‡»é¡¶éƒ¨æ¨ªæ å±•å¼€/æŠ˜å                                  â•‘")
print("â•‘    âœ… æŠ˜å æ—¶æ˜¾ç¤ºç²¾ç®€ä¿¡æ¯ï¼ˆç‹‚æš´å€¼+è„è¯ç‡ï¼‰                   â•‘")
print("â•‘    âœ… æ‰‹æœºä¼˜åŒ–ï¼šå¤§ç‚¹å‡»åŒºåŸŸ                                  â•‘")
print("â•‘    æŠ˜å çŠ¶æ€ï¼š                                                â•‘")
print("â•‘    - æ˜¾ç¤ºï¼šğŸ’€ ç‹‚æš´å€¼ | ğŸ¤¬ è„è¯ç‡ | ğŸ“š å­—åº“è¯æ•°              â•‘")
print("â•‘    - ç‚¹å‡»ä»»æ„ä½ç½®å±•å¼€ï¼Œç»§ç»­ä½¿ç”¨å…¨éƒ¨åŠŸèƒ½                     â•‘")
print("â•‘    å­—åº“è¯æ•°ï¼š" .. #swearWordList .. "ä¸ª                                 â•‘")
print("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
