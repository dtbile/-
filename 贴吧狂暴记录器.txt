--[[
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  ğŸ’€ è´´å§ç‹‚æš´è®°å½•å™¨ v1.0.4 + Detector v4.0 ä¸€é”®å®Œæ•´ç‰ˆ ğŸ’€                 â•‘
â•‘  âœ… ä¸è¦†ç›– OnIncomingMessageï¼ˆé¿å…å†²çªï¼‰                                â•‘
â•‘  âœ… å¤šè·¯æŠ“èŠå¤©ï¼šTCS.MessageReceived + DefaultChatEvents + Chatted       â•‘
â•‘  âœ… Detector æ‰«æä½œä¸ºè„è¯åˆ¤å®š/è¯„åˆ†æ¥æºï¼ˆæ›´æŠ—ç»•è¿‡ï¼‰                       â•‘
â•‘  âœ… å…¨åŠŸèƒ½ï¼šè¿‡æ»¤/èœå•/åå•é™éŸ³/ä¿å­˜å¯¼å‡ºå¤åˆ¶/æŠ˜å /ç½®é¡¶/æœç´¢/ç»Ÿè®¡          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
--]]

repeat task.wait() until game:GetService("Players").LocalPlayer

-- ===== Services =====
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local okTCS, TextChatService = pcall(function() return game:GetService("TextChatService") end)
if not okTCS then TextChatService = nil end

local localPlayer = Players.LocalPlayer
local playerGui = localPlayer:WaitForChild("PlayerGui")

-- ===== ä½ åªéœ€è¦æ”¹è¿™é‡Œ =====
local DETECTOR_URL = "https://raw.githubusercontent.com/dtbile/-/refs/heads/main/words.txt" -- Detectorå¼•æ“ï¼ˆreturn Detectorï¼‰
local WORDS_TABLE_URL = "https://raw.githubusercontent.com/dtbile/-/refs/heads/main/words.lua" -- ä½ çš„å­—åº“ rawï¼ˆå¿…é¡» return tableï¼‰ï¼Œæ²¡æœ‰å°±ç•™ç©ºç”¨å†…ç½®fallback
-- ======================

-- ===== Config =====
local Config = {
    Version = "v1.0.4+Detector",
    FileName = "è´´å§èŠå¤©è®°å½•.txt",

    MaxHistory = 3000,
    MaxRender = 260,
    RenderQueueMax = 1200,
    AutoSaveInterval = 180,
    SaveTimeout = 3,

    DefaultWidth = 500,
    DefaultHeight = 700,
    MinWidth = 360,
    MinHeight = 160,
    MaxWidth = 980,
    MaxHeight = 1100,
    CollapsedHeight = 96,

    FontSize = 18,
    SmoothAnimations = true,
    StatsUpdateHz = 4,

    WindowSeconds = 180,
    WindowMaxMessages = 160,

    Colors = {
        Primary   = Color3.fromRGB(255, 45, 85),
        Secondary = Color3.fromRGB(0, 255, 255),
        Accent    = Color3.fromRGB(255, 215, 0),
        Background= Color3.fromRGB(5, 5, 15),
        Panel     = Color3.fromRGB(12, 12, 20),
        Text      = Color3.fromRGB(255, 255, 255),
        System    = Color3.fromRGB(255, 215, 0),
        Muted     = Color3.fromRGB(130, 130, 130),
        Danger    = Color3.fromRGB(255, 60, 60),
        Success   = Color3.fromRGB(0, 200, 0),
        Dim       = Color3.fromRGB(160, 160, 160),
    }
}

local Features = {
    showPlayers = true,
    showRuntime = true,
    showWordCount = true, -- æ˜¾ç¤ºè¯åº“è¯æ•°ï¼ˆå¦‚æœä½ ç»™äº†words tableï¼‰
    showSwearRate = true,
    smoothAnimations = true,
}

local CategoryFilter = {
    showCHAT = true,
    showSYSTEM = true,

    SYS_START = true,
    SYS_CHATFLOW = true,
    SYS_JOINLEAVE = true,
    SYS_STATS = true,
    SYS_SAVE = true,
    SYS_EXPORT = true,
    SYS_HINT = true,
}

-- ===== Utils =====
local function clamp(n,a,b) if n<a then return a elseif n>b then return b else return n end end
local function nowStr() return os.date("%Y-%m-%d %H:%M:%S") end
local function nz(x, d) if type(x)=="number" then return x else return d or 0 end end

local function tween(obj, t, props)
    if not obj then return end
    if not Config.SmoothAnimations or not Features.smoothAnimations then
        for k,v in pairs(props) do obj[k]=v end
        return
    end
    TweenService:Create(obj, TweenInfo.new(t, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), props):Play()
end

local function safeLoadFromUrl(url)
    if not url or url=="" then return nil, "empty url" end
    local ok, src = pcall(function() return game:HttpGet(url) end)
    if not ok or type(src)~="string" then return nil, "httpget failed" end
    local ok2, mod = pcall(function() return loadstring(src)() end)
    if not ok2 then return nil, "loadstring failed" end
    return mod, nil
end

-- ===== Load Detector + Words Table =====
local Detector = nil
do
    local mod = select(1, safeLoadFromUrl(DETECTOR_URL))
    if type(mod)=="table" and type(mod.new)=="function" and type(mod.scan)=="function" then
        Detector = mod
    end
end

-- fallback words tableï¼ˆä¿è¯èƒ½è·‘ï¼›å»ºè®®ä½ æ¢æˆè‡ªå·±çš„ full å­—åº“ rawï¼‰
local FALLBACK_WORDS = {
    chinese_basic = {"è‰","æ“","è‰¹","è‚","æ—¥","é ","æ»š","çˆ¬","æ€¼","æ·¦","å¦ˆ","çˆ¹","çˆ·","å‚»é€¼","åƒåœ¾","åºŸç‰©","ç‹—å±","ç‹—å±"},
    abbrev = {"sb","cnm","nmsl","tmd","wdnmd","mlgb","wqnmlgb"},
    leet = {"c4o","ca0","f**k","fuk","fk","sh1t","b1tch","bi7ch"},
    memes = {"ğŸ’€","ğŸ¤¡","ğŸ¶","ğŸ‘½"},
}

local wordsTable = nil
do
    if WORDS_TABLE_URL ~= "" then
        local mod = select(1, safeLoadFromUrl(WORDS_TABLE_URL))
        if type(mod)=="table" then wordsTable = mod end
    end
    if not wordsTable then wordsTable = FALLBACK_WORDS end
end

local det = nil
local totalWordCount = 0
if Detector then
    local ok, inst = pcall(function() return Detector.new(wordsTable) end)
    if ok then det = inst end
end
do
    local c=0
    for _,list in pairs(wordsTable) do
        if type(list)=="table" then c += #list end
    end
    totalWordCount=c
end

-- ===== State =====
local state = {
    chatHistory = {},
    renderQueue = {},
    messageStats = {},
    mutedPlayers = {},
    isSaving = false,

    startTime = os.time(),
    uiVisible = true,
    isCollapsed = false,
    pinned = "BR",

    fontSize = Config.FontSize,
    width = Config.DefaultWidth,
    height = Config.DefaultHeight,
}

-- ===== Window buffer =====
local Window = { items = {} } -- {t=os.time(), meta={...}}

local function windowPrune(nowT)
    local cutoff = nowT - Config.WindowSeconds
    while #Window.items > 0 and Window.items[1].t < cutoff do table.remove(Window.items,1) end
    while #Window.items > Config.WindowMaxMessages do table.remove(Window.items,1) end
end

local function windowAdd(meta)
    local nowT = os.time()
    table.insert(Window.items, {t = nowT, meta = meta})
    windowPrune(nowT)
end

-- ===== Detector scan wrapper =====
local function scanText(text)
    if not det then
        return {hit=false, score=0, level="clean", matches={}}
    end
    local ok, r = pcall(function() return det:scan(text) end)
    if ok and type(r)=="table" then
        r.hit = (r.hit == true)
        r.score = nz(r.score,0)
        r.level = tostring(r.level or "clean")
        return r
    end
    return {hit=false, score=0, level="clean", matches={}}
end

-- ===== Analysis / BaZhi =====
local quickEmojis = {"ğŸ˜‚","ğŸ¤£","ğŸ˜­","ğŸ˜¡","ğŸ¤¬","ğŸ’€","ğŸ”¥","ğŸ’¯","ğŸ‘½","ğŸ¦¶","ğŸ˜¤","ğŸ˜","ğŸ™","âœ…","âŒ","âš¡","â­","âœ¨","ğŸ’¥","ğŸ’©"}
local function detectEmojiCount(msg)
    local c=0
    for _,e in ipairs(quickEmojis) do
        local _,n = msg:gsub(e,"")
        c += n
    end
    return c
end

local function countPattern(msg, pat)
    local _,n = msg:gsub(pat,"")
    return n
end

local function detectRepeatBurst(msg)
    local ok, burst = pcall(function()
        local last=nil
        local streak=0
        local hits=0
        for _, code in utf8.codes(msg) do
            local ch = utf8.char(code)
            if ch == last then
                streak += 1
            else
                if streak >= 5 then hits += 1 end
                last = ch
                streak = 1
            end
        end
        if streak >= 5 then hits += 1 end
        return hits
    end)
    if ok then return burst end
    return 0
end

local function analyzeChatMessage(rawLine)
    -- rawLine: "nameï¼šmsg"
    local ex  = countPattern(rawLine,"!") + countPattern(rawLine,"ï¼")
    local qu  = countPattern(rawLine,"%?") + countPattern(rawLine,"ï¼Ÿ")
    local hash= countPattern(rawLine,"#")
    local emoji = detectEmojiCount(rawLine)
    local repeatBurst = detectRepeatBurst(rawLine)

    -- æ ¸å¿ƒï¼šç”¨ Detector åˆ¤å®šè„è¯/è¯„åˆ†
    local r = scanText(rawLine)

    return {
        len=#rawLine,
        ex=ex, qu=qu, hash=hash,
        emoji=emoji,
        repeatBurst=repeatBurst,

        swear = r.hit,
        detScore = nz(r.score,0),
    }
end

local function computeBaZhi()
    local nowT = os.time()
    windowPrune(nowT)
    local n = #Window.items
    if n < 2 then return 0 end

    local swearMsgs=0
    local sumPunct=0
    local sumHash=0
    local sumEmoji=0
    local sumRepeat=0
    local sumDet=0

    -- burstï¼ˆ4ç§’å†…åˆ·å±ï¼‰
    local burst=0
    do
        local t0 = Window.items[n].t
        local c=0
        for i=n,1,-1 do
            if (t0 - Window.items[i].t) <= 4 then c += 1 else break end
        end
        burst=c
    end

    for i=1,n do
        local a=Window.items[i].meta
        if a.swear then swearMsgs += 1 end
        sumPunct += (nz(a.ex,0)*1.2 + nz(a.qu,0)*1.0)
        sumHash  += nz(a.hash,0)
        sumEmoji += nz(a.emoji,0)
        sumRepeat+= nz(a.repeatBurst,0)
        sumDet   += nz(a.detScore,0)
    end

    local swearRate = swearMsgs / n

    -- 60%ï¼šDetectorå‘½ä¸­ç‡ï¼ˆæ›´çœŸå®ï¼‰
    local score = 0
    score += clamp(swearRate * 120, 0, 60)

    -- 20%ï¼šåˆ·å±ï¼ˆmps + burstï¼‰
    local span = math.max(1, Window.items[n].t - Window.items[1].t)
    local mps = n / span
    score += clamp((mps/1.8)*12, 0, 12)
    score += clamp((burst/7)*8, 0, 8)

    -- 20%ï¼šæƒ…ç»ªï¼ˆç¬¦å·/emoji/é‡å¤ï¼‰
    score += clamp((sumPunct/n)*2.2, 0, 10)
    score += clamp((sumEmoji/n)*2.0, 0, 5)
    score += clamp((sumRepeat/n)*3.0, 0, 5)

    -- Detectoråˆ†å€¼åšä¸ªå¾®è°ƒï¼ˆé¿å…â€œå…¨æ˜¯ä½çº§è¯ä¹Ÿçˆ†è¡¨â€ï¼‰
    local avgDet = sumDet / n
    score += clamp((avgDet/10)*4, 0, 4) -- æœ€å¤š+4

    return math.floor(clamp(score,0,100))
end

local function getSwearRateWindow()
    local nowT=os.time()
    windowPrune(nowT)
    local n=#Window.items
    if n==0 then return 0 end
    local s=0
    for i=1,n do if Window.items[i].meta.swear then s+=1 end end
    return math.floor((s/n)*100)
end

local function getBaZhiLevel(v)
    if v < 20 then return "ğŸ•Šï¸ å’Œå¹³é¸½", Color3.fromRGB(100,255,100) end
    if v < 40 then return "ğŸ˜ èŒæ–°", Color3.fromRGB(200,255,100) end
    if v < 60 then return "ğŸ˜¤ æš´èºè€å“¥", Color3.fromRGB(255,200,100) end
    if v < 80 then return "ğŸ¤¬ è´´å§æˆ˜ç¥", Color3.fromRGB(255,100,100) end
    return "ğŸ’€ ç‹‚æš´ã®ç¥", Color3.fromRGB(255,50,50)
end

-- ===== UI =====
local UI = {
    gui=nil, main=nil, titleBar=nil,
    scroll=nil, listLayout=nil,
    infoLabel=nil, searchBox=nil,

    panelMenu=nil, panelFilter=nil, panelPeople=nil,
    bar=nil, handle=nil,

    btnFoldTop=nil,
    labels={}, pool={},
    filterText="",
}

local function uiAlive()
    return UI.gui and UI.main and UI.main.Parent ~= nil
end

local function categoryAllowed(cat)
    if cat=="CHAT" then return CategoryFilter.showCHAT end
    if not CategoryFilter.showSYSTEM then return false end
    return CategoryFilter[cat] ~= false
end

local function shouldShowEntry(entry)
    if not categoryAllowed(entry.cat) then return false end
    if UI.filterText=="" then return true end
    return string.find(string.lower(entry.text), UI.filterText, 1, true) ~= nil
end

local function getLabel()
    local lbl = table.remove(UI.pool)
    if lbl then
        lbl.Visible=true
        lbl.Text=""
        return lbl
    end
    lbl = Instance.new("TextLabel")
    lbl.BackgroundTransparency=1
    lbl.Size=UDim2.new(1,-10,0,0)
    lbl.AutomaticSize=Enum.AutomaticSize.Y
    lbl.TextWrapped=true
    lbl.RichText=false
    lbl.TextXAlignment=Enum.TextXAlignment.Left
    lbl.TextYAlignment=Enum.TextYAlignment.Top
    lbl.Font=Enum.Font.SourceSans
    lbl.TextSize=state.fontSize
    return lbl
end

local function recycleLabel(lbl)
    if not lbl then return end
    lbl.Visible=false
    lbl.Parent=nil
    table.insert(UI.pool,lbl)
end

local function clearRendered()
    for _,lbl in ipairs(UI.labels) do recycleLabel(lbl) end
    UI.labels={}
end

local function renderAll()
    if not uiAlive() or state.isCollapsed then return end
    clearRendered()

    local shown=0
    local start = math.max(1, #state.renderQueue - Config.RenderQueueMax + 1)
    for i=start, #state.renderQueue do
        local e=state.renderQueue[i]
        if e and shouldShowEntry(e) then
            local lbl=getLabel()
            lbl.Parent=UI.scroll
            lbl.Text=e.text
            lbl.TextSize=state.fontSize
            lbl.TextColor3=e.color or Config.Colors.Text
            table.insert(UI.labels,lbl)
            shown += 1
            if shown>=Config.MaxRender then break end
        end
    end

    task.defer(function()
        if uiAlive() and UI.scroll then UI.scroll.CanvasPosition=Vector2.new(0,1e9) end
    end)
end

local function appendRender(entry)
    table.insert(state.renderQueue, entry)
    if #state.renderQueue > Config.RenderQueueMax then table.remove(state.renderQueue,1) end
    if not uiAlive() or state.isCollapsed then return end

    if UI.filterText ~= "" or not categoryAllowed(entry.cat) then
        renderAll()
        return
    end

    local lbl=getLabel()
    lbl.Parent=UI.scroll
    lbl.Text=entry.text
    lbl.TextSize=state.fontSize
    lbl.TextColor3=entry.color or Config.Colors.Text
    table.insert(UI.labels,lbl)

    if #UI.labels > Config.MaxRender then recycleLabel(table.remove(UI.labels,1)) end

    task.defer(function()
        if uiAlive() and UI.scroll then UI.scroll.CanvasPosition=Vector2.new(0,1e9) end
    end)
end

local function pushHistory(full)
    table.insert(state.chatHistory, full)
    if #state.chatHistory > Config.MaxHistory then table.remove(state.chatHistory,1) end
end

local function addEntry(rawText, cat, colorOverride)
    local full = ("[%s] %s"):format(nowStr(), rawText)
    pushHistory(full)
    local color = colorOverride or (cat=="CHAT" and Config.Colors.Text or Config.Colors.System)
    appendRender({text=full, cat=cat, color=color})
end

local function addSystem(text, sysCat)
    sysCat = sysCat or "SYS_HINT"
    addEntry("ğŸ§  ç³»ç»Ÿï¼š"..text, sysCat, Config.Colors.System)
end

local function addChat(speaker, msg)
    local muted = (speaker and state.mutedPlayers[speaker])==true
    local raw = (speaker==localPlayer.Name) and ("æˆ‘ï¼š"..msg) or (speaker.."ï¼š"..msg)

    addEntry(raw, "CHAT", muted and Config.Colors.Muted or Config.Colors.Text)
    windowAdd(analyzeChatMessage(raw))

    if speaker and speaker ~= localPlayer.Name then
        state.messageStats[speaker]=(state.messageStats[speaker] or 0)+1
    end
end

-- ===== Save/Export/Copy =====
local function writeAllPossible(paths, content)
    for _,p in ipairs(paths) do
        pcall(function() if writefile then writefile(p, content) end end)
    end
end

local function buildSaveContent()
    local bz=computeBaZhi()
    local lvl=select(1,getBaZhiLevel(bz))
    local content=""
    content ..="â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n"
    content ..="â•‘ è´´å§ç‹‚æš´èŠå¤©è®°å½• "..nowStr().."\n"
    content ..="â•‘ ç‰ˆæœ¬ï¼š"..Config.Version.."\n"
    content ..="â•‘ ç©å®¶ï¼š"..localPlayer.Name.."\n"
    content ..="â•‘ æ€»è®°å½•ï¼š"..tostring(#state.chatHistory).." æ¡\n"
    content ..=("â•‘ Detectorï¼š%s | å­—åº“è¯æ•°ï¼š%d\n"):format(det and "ON" or "OFF", totalWordCount)
    content ..="â•‘ è¿‘çª—ç‹‚æš´å€¼ï¼š"..tostring(bz).."%ï¼Œç­‰çº§ï¼š"..lvl.."\n"
    content ..="â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n"
    for i=1,#state.chatHistory do content ..= state.chatHistory[i].."\n" end
    return content
end

local function saveToFileAsync(cb)
    if state.isSaving then if cb then cb(false,"æ­£åœ¨ä¿å­˜ä¸­") end return end
    state.isSaving=true
    task.spawn(function()
        local ok=false
        local err="æœªçŸ¥é”™è¯¯"
        local timeout=false

        task.spawn(function()
            task.wait(Config.SaveTimeout)
            timeout=true
        end)

        local ok2, e2 = pcall(function()
            local content=buildSaveContent()
            local paths = {
                Config.FileName,
                "./"..Config.FileName,
                "èŠå¤©è®°å½•_"..os.date("%Y%m%d_%H%M%S")..".txt",
                "/storage/emulated/0/"..Config.FileName,
            }
            writeAllPossible(paths, content)
        end)

        if timeout then ok=false; err="ä¿å­˜è¶…æ—¶"
        elseif ok2 then ok=true
        else ok=false; err=tostring(e2) end

        state.isSaving=false
        if cb then cb(ok,err) end
    end)
end

-- ===== UI build =====
local function setPinnedPosition()
    if not uiAlive() then return end
    local pad=10
    local w=state.width
    local h=state.isCollapsed and Config.CollapsedHeight or state.height

    if state.pinned=="BR" then
        UI.main.Position = UDim2.new(1,-w-pad,1,-h-pad)
    elseif state.pinned=="TR" then
        UI.main.Position = UDim2.new(1,-w-pad,0,pad)
    elseif state.pinned=="BL" then
        UI.main.Position = UDim2.new(0,pad,1,-h-pad)
    else
        UI.main.Position = UDim2.new(0,pad,0,pad)
    end
end

local function createCapsule(parent, x, y, w, text)
    local b=Instance.new("TextButton")
    b.Size=UDim2.new(0,w,0,26)
    b.Position=UDim2.new(0,x,0,y)
    b.BackgroundColor3=Color3.fromRGB(0,0,0)
    b.BackgroundTransparency=0.55
    b.BorderSizePixel=0
    b.Text=text
    b.TextColor3=Color3.new(1,1,1)
    b.TextSize=13
    b.Font=Enum.Font.GothamBold
    b.Parent=parent
    local cr=Instance.new("UICorner"); cr.CornerRadius=UDim.new(0,999); cr.Parent=b
    local st=Instance.new("UIStroke"); st.Thickness=1; st.Transparency=0.6; st.Color=Config.Colors.Secondary; st.Parent=b
    return b, st
end

local function setCapsule(btn, stroke, on, color)
    if on then
        btn.BackgroundTransparency=0.25
        stroke.Transparency=0.2
        stroke.Color=color
    else
        btn.BackgroundTransparency=0.7
        stroke.Transparency=0.8
        stroke.Color=Config.Colors.Dim
    end
end

local function rebuildPeopleList(listFrame)
    if not uiAlive() then return end
    listFrame:ClearAllChildren()

    local layout=Instance.new("UIListLayout")
    layout.Padding=UDim.new(0,6)
    layout.SortOrder=Enum.SortOrder.LayoutOrder
    layout.Parent=listFrame

    local function addPerson(name)
        local muted = state.mutedPlayers[name]==true
        local b=Instance.new("TextButton")
        b.Size=UDim2.new(1,-10,0,28)
        b.BackgroundTransparency=0.15
        b.BackgroundColor3 = muted and Config.Colors.Danger or Config.Colors.Secondary
        b.TextColor3 = Color3.new(0,0,0)
        b.TextSize=14
        b.Font=Enum.Font.GothamBold
        b.Text=(muted and "ğŸ”‡ " or "ğŸ”Š ")..name
        b.BorderSizePixel=0
        b.Parent=listFrame
        b.MouseButton1Click:Connect(function()
            state.mutedPlayers[name]=not state.mutedPlayers[name]
            addSystem("å·²åˆ‡æ¢é™éŸ³ -> "..name, "SYS_HINT")
            rebuildPeopleList(listFrame)
            renderAll()
        end)
    end

    for _,p in ipairs(Players:GetPlayers()) do
        if p~=localPlayer then addPerson(p.Name) end
    end
end

local function buildInfoText()
    local parts={}
    table.insert(parts, ("ğŸ‘¥%d"):format(#Players:GetPlayers()))
    local bz=computeBaZhi()
    local lvl,c=getBaZhiLevel(bz)
    table.insert(parts, ("%s %d%%"):format(lvl,bz))
    if Features.showSwearRate then table.insert(parts, ("ğŸ¤¬%d%%"):format(getSwearRateWindow())) end
    if Features.showWordCount then table.insert(parts, ("ğŸ“š%d"):format(totalWordCount)) end
    table.insert(parts, ("Detector:%s"):format(det and "ON" or "OFF"))
    if Features.showRuntime then
        local rt=os.difftime(os.time(), state.startTime)
        table.insert(parts, ("â±ï¸%dm"):format(math.floor(rt/60)))
    end
    return table.concat(parts," | "), c
end

local function updateInfo()
    if not uiAlive() or not UI.infoLabel then return end
    local ok, t, c = pcall(function()
        local text, col = buildInfoText()
        return text, col
    end)
    if not ok then
        UI.infoLabel.Text="âš ï¸ info crashï¼ˆå·²å…œåº•ï¼‰"
        UI.infoLabel.TextColor3=Config.Colors.Danger
        return
    end
    UI.infoLabel.Text=t
    UI.infoLabel.TextColor3=c or Config.Colors.Secondary
end

local function applyCollapsedUI()
    if not uiAlive() then return end
    UI.panelMenu.Visible=false
    UI.panelFilter.Visible=false
    if UI.panelPeople then UI.panelPeople.Visible=false end

    if state.isCollapsed then
        tween(UI.main, 0.22, {Size=UDim2.new(0,state.width,0,Config.CollapsedHeight)})
        UI.scroll.Visible=false
        UI.bar.Visible=false
        UI.handle.Visible=false
        UI.btnFoldTop.Text="â–²"
    else
        tween(UI.main, 0.22, {Size=UDim2.new(0,state.width,0,state.height)})
        UI.scroll.Visible=true
        UI.bar.Visible=true
        UI.handle.Visible=true
        UI.btnFoldTop.Text="â–¼"
        renderAll()
    end
    setPinnedPosition()
end

local function createUI()
    local old = playerGui:FindFirstChild("ChatLoggerGUI")
    if old then old:Destroy() end

    UI = {labels={}, pool={}, filterText=""}

    local gui=Instance.new("ScreenGui")
    gui.Name="ChatLoggerGUI"
    gui.ResetOnSpawn=false
    gui.Parent=playerGui
    UI.gui=gui

    local main=Instance.new("Frame")
    main.Size=UDim2.new(0,state.width,0,state.height)
    main.BackgroundColor3=Config.Colors.Background
    main.BackgroundTransparency=0.08
    main.BorderSizePixel=0
    main.ClipsDescendants=true
    main.Active=true
    main.Parent=gui
    UI.main=main

    local stroke=Instance.new("UIStroke")
    stroke.Thickness=2
    stroke.Color=Config.Colors.Primary
    stroke.Transparency=0.15
    stroke.Parent=main

    local titleBar=Instance.new("Frame")
    titleBar.Size=UDim2.new(1,0,0,86)
    titleBar.BackgroundColor3=Config.Colors.Primary
    titleBar.BackgroundTransparency=0.22
    titleBar.BorderSizePixel=0
    titleBar.Parent=main
    UI.titleBar=titleBar

    local title=Instance.new("TextLabel")
    title.BackgroundTransparency=1
    title.Size=UDim2.new(1,-330,0,40)
    title.Position=UDim2.new(0,14,0,0)
    title.TextXAlignment=Enum.TextXAlignment.Left
    title.Font=Enum.Font.GothamBold
    title.TextSize=state.fontSize+3
    title.TextColor3=Color3.new(1,1,1)
    title.Text="ğŸ’€ è´´å§ç‹‚æš´è®°å½•å™¨ "..Config.Version
    title.Parent=titleBar

    local search=Instance.new("TextBox")
    search.Size=UDim2.new(0,190,0,28)
    search.Position=UDim2.new(1,-308,0,6)
    search.BackgroundColor3=Color3.fromRGB(0,0,0)
    search.BackgroundTransparency=0.35
    search.TextColor3=Color3.new(1,1,1)
    search.PlaceholderText="ğŸ” æœç´¢è¿‡æ»¤..."
    search.PlaceholderColor3=Color3.fromRGB(200,200,200)
    search.Text=""
    search.ClearTextOnFocus=false
    search.Font=Enum.Font.SourceSans
    search.TextSize=14
    search.BorderSizePixel=0
    search.Parent=titleBar
    UI.searchBox=search

    local function mkTopBtn(x, text, bg, tc)
        local b=Instance.new("TextButton")
        b.Size=UDim2.new(0,40,0,40)
        b.Position=UDim2.new(1,x,0,0)
        b.BackgroundColor3=bg
        b.BackgroundTransparency=0.2
        b.BorderSizePixel=0
        b.Text=text
        b.TextSize=20
        b.Font=Enum.Font.GothamBold
        b.TextColor3=tc or Color3.new(0,0,0)
        b.Parent=titleBar
        return b
    end

    local btnMenu   = mkTopBtn(-60,  "âš™ï¸", Config.Colors.Secondary)
    local btnFilter = mkTopBtn(-110, "ğŸ§©", Config.Colors.Accent)
    local btnHide   = mkTopBtn(-160, "âœ–",  Color3.fromRGB(255,255,255), Color3.new(0,0,0))
    local btnFoldTop= mkTopBtn(-210, "â–¼",  Color3.fromRGB(255,255,255), Color3.new(0,0,0))
    UI.btnFoldTop=btnFoldTop

    local chipRow=Instance.new("Frame")
    chipRow.Size=UDim2.new(1,-20,0,34)
    chipRow.Position=UDim2.new(0,10,0,46)
    chipRow.BackgroundTransparency=1
    chipRow.Parent=titleBar

    local chipChat, stChat = createCapsule(chipRow, 0, 4, 90, "ğŸ’¬ èŠå¤©")
    local chipSys,  stSys  = createCapsule(chipRow, 98,4, 90, "ğŸ§  ç³»ç»Ÿ")
    local function refreshChips()
        setCapsule(chipChat, stChat, CategoryFilter.showCHAT, Config.Colors.Secondary)
        setCapsule(chipSys,  stSys,  CategoryFilter.showSYSTEM, Config.Colors.Accent)
    end
    refreshChips()

    chipChat.MouseButton1Click:Connect(function()
        CategoryFilter.showCHAT = not CategoryFilter.showCHAT
        refreshChips(); renderAll()
    end)
    chipSys.MouseButton1Click:Connect(function()
        CategoryFilter.showSYSTEM = not CategoryFilter.showSYSTEM
        refreshChips(); renderAll()
    end)

    local scroll=Instance.new("ScrollingFrame")
    scroll.Size=UDim2.new(1,-20,1,-210)
    scroll.Position=UDim2.new(0,10,0,94)
    scroll.BackgroundColor3=Color3.new(0,0,0)
    scroll.BackgroundTransparency=0.45
    scroll.BorderSizePixel=0
    scroll.ScrollBarThickness=8
    scroll.ScrollBarImageColor3=Config.Colors.Secondary
    scroll.Parent=main
    UI.scroll=scroll

    local layout=Instance.new("UIListLayout")
    layout.Padding=UDim.new(0,4)
    layout.SortOrder=Enum.SortOrder.LayoutOrder
    layout.Parent=scroll
    UI.listLayout=layout
    layout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
        if uiAlive() then scroll.CanvasSize=UDim2.new(0,0,0,layout.AbsoluteContentSize.Y+10) end
    end)

    local bar=Instance.new("Frame")
    bar.Size=UDim2.new(1,-20,0,96)
    bar.Position=UDim2.new(0,10,1,-132)
    bar.BackgroundTransparency=1
    bar.Parent=main
    UI.bar=bar

    local function mkBtn(x,y,w,text,bg)
        local b=Instance.new("TextButton")
        b.Size=UDim2.new(0,w,0,36)
        b.Position=UDim2.new(0,x,0,y)
        b.BackgroundColor3=bg
        b.BackgroundTransparency=0.18
        b.BorderSizePixel=0
        b.Text=text
        b.TextColor3=Color3.new(1,1,1)
        b.TextSize=state.fontSize-2
        b.Font=Enum.Font.GothamBold
        b.Parent=bar
        return b
    end

    local bSave   = mkBtn(0,   0, 78, "ğŸ’¾ä¿å­˜", Config.Colors.Success)
    local bExport = mkBtn(86,  0, 78, "ğŸ“¤å¯¼å‡º", Color3.fromRGB(0,150,255))
    local bCopy   = mkBtn(172, 0, 78, "ğŸ“‹å¤åˆ¶", Color3.fromRGB(120,120,120))
    local bStats  = mkBtn(258, 0, 78, "ğŸ“Šç»Ÿè®¡", Color3.fromRGB(150,0,255))
    local bPeople = mkBtn(344, 0, 88, "ğŸ‘¥åå•", Color3.fromRGB(0,200,200))

    local bFont   = mkBtn(0,   44, 78, "ğŸ”¤å­—ä½“", Color3.fromRGB(90,90,90))
    local bClear  = mkBtn(86,  44, 78, "ğŸ—‘ï¸æ¸…ç©º", Color3.fromRGB(255,100,0))
    local bPin    = mkBtn(172, 44, 78, "ğŸ“Œç½®é¡¶", Color3.fromRGB(200,0,200))
    local bClose  = mkBtn(258, 44, 78, "â»å…³é—­", Config.Colors.Danger)
    local bDummy  = mkBtn(344, 44, 88, " ", Color3.fromRGB(0,0,0))
    bDummy.BackgroundTransparency=1
    bDummy.Text=""

    local info=Instance.new("TextLabel")
    info.Size=UDim2.new(1,-20,0,22)
    info.Position=UDim2.new(0,10,1,-28)
    info.BackgroundTransparency=1
    info.TextXAlignment=Enum.TextXAlignment.Left
    info.Font=Enum.Font.SourceSansBold
    info.TextSize=state.fontSize-4
    info.TextColor3=Config.Colors.Secondary
    info.Parent=main
    UI.infoLabel=info

    local handle=Instance.new("Frame")
    handle.Size=UDim2.new(0,20,0,20)
    handle.Position=UDim2.new(1,-20,1,-20)
    handle.BackgroundColor3=Config.Colors.Secondary
    handle.BackgroundTransparency=0.45
    handle.BorderSizePixel=0
    handle.Parent=main
    UI.handle=handle

    -- panels
    local function mkPanel(sizeY, titleText, titleBg, titleTC)
        local p=Instance.new("Frame")
        p.Size=UDim2.new(0, 270, 0, sizeY)
        p.Position=UDim2.new(1, -280, 0, 94)
        p.BackgroundColor3=Config.Colors.Panel
        p.BackgroundTransparency=0.12
        p.BorderSizePixel=0
        p.Visible=false
        p.Parent=main
        local t=Instance.new("TextLabel")
        t.Size=UDim2.new(1,0,0,32)
        t.BackgroundColor3=titleBg
        t.BackgroundTransparency=0.25
        t.BorderSizePixel=0
        t.Text=titleText
        t.TextColor3=titleTC
        t.Font=Enum.Font.GothamBold
        t.TextSize=16
        t.Parent=p
        return p
    end
    UI.panelFilter = mkPanel(270, "ğŸ§© ç³»ç»Ÿç»†åˆ†è¿‡æ»¤", Config.Colors.Accent, Color3.new(0,0,0))
    UI.panelMenu   = mkPanel(220, "âš™ï¸ æ˜¾ç¤ºé¡¹", Config.Colors.Secondary, Color3.new(0,0,0))

    UI.panelPeople = Instance.new("Frame")
    UI.panelPeople.Size=UDim2.new(0, 240, 0, 360)
    UI.panelPeople.Position=UDim2.new(0,10,0,94)
    UI.panelPeople.BackgroundColor3=Config.Colors.Panel
    UI.panelPeople.BackgroundTransparency=0.12
    UI.panelPeople.BorderSizePixel=0
    UI.panelPeople.Visible=false
    UI.panelPeople.Parent=main

    do
        local t=Instance.new("TextLabel")
        t.Size=UDim2.new(1,0,0,32)
        t.BackgroundColor3=Config.Colors.Secondary
        t.BackgroundTransparency=0.25
        t.BorderSizePixel=0
        t.Text="ğŸ‘¥ ç‚¹äººé™éŸ³"
        t.TextColor3=Color3.new(0,0,0)
        t.Font=Enum.Font.GothamBold
        t.TextSize=16
        t.Parent=UI.panelPeople
    end

    local peopleList=Instance.new("ScrollingFrame")
    peopleList.Size=UDim2.new(1,-10,1,-42)
    peopleList.Position=UDim2.new(0,5,0,36)
    peopleList.BackgroundTransparency=1
    peopleList.BorderSizePixel=0
    peopleList.ScrollBarThickness=6
    peopleList.ScrollBarImageColor3=Config.Colors.Secondary
    peopleList.Parent=UI.panelPeople

    local pplLayout=Instance.new("UIListLayout")
    pplLayout.Padding=UDim.new(0,6)
    pplLayout.SortOrder=Enum.SortOrder.LayoutOrder
    pplLayout.Parent=peopleList
    pplLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
        if uiAlive() then peopleList.CanvasSize=UDim2.new(0,0,0,pplLayout.AbsoluteContentSize.Y+10) end
    end)

    -- filter toggles
    local function mkToggle(parent, y, key, label, onColor)
        local row=Instance.new("TextButton")
        row.Size=UDim2.new(1,-12,0,28)
        row.Position=UDim2.new(0,6,0,y)
        row.BackgroundColor3=Color3.fromRGB(0,0,0)
        row.BackgroundTransparency=0.55
        row.BorderSizePixel=0
        row.Text=""
        row.Parent=parent

        local txt=Instance.new("TextLabel")
        txt.BackgroundTransparency=1
        txt.Size=UDim2.new(1,-60,1,0)
        txt.Position=UDim2.new(0,10,0,0)
        txt.TextXAlignment=Enum.TextXAlignment.Left
        txt.Font=Enum.Font.GothamBold
        txt.TextSize=13
        txt.TextColor3=Color3.new(1,1,1)
        txt.Text=label
        txt.Parent=row

        local tag=Instance.new("TextLabel")
        tag.BackgroundTransparency=1
        tag.Size=UDim2.new(0,50,1,0)
        tag.Position=UDim2.new(1,-54,0,0)
        tag.Font=Enum.Font.GothamBold
        tag.TextSize=12
        tag.TextColor3=Color3.new(1,1,1)
        tag.Parent=row

        local st=Instance.new("UIStroke")
        st.Thickness=1
        st.Parent=row

        local function refresh()
            local on=CategoryFilter[key]
            tag.Text = on and "ON" or "OFF"
            if on then
                row.BackgroundTransparency=0.35
                st.Transparency=0.25
                st.Color=onColor
            else
                row.BackgroundTransparency=0.7
                st.Transparency=0.8
                st.Color=Config.Colors.Dim
            end
        end
        refresh()

        row.MouseButton1Click:Connect(function()
            CategoryFilter[key]=not CategoryFilter[key]
            refresh()
            renderAll()
        end)
    end

    mkToggle(UI.panelFilter, 44,  "SYS_START",     "ğŸš€ å¯åŠ¨/åˆå§‹åŒ–", Config.Colors.Secondary)
    mkToggle(UI.panelFilter, 76,  "SYS_CHATFLOW",  "ğŸ’¬ èŠå¤©ç³»ç»ŸçŠ¶æ€", Config.Colors.Secondary)
    mkToggle(UI.panelFilter, 108, "SYS_JOINLEAVE", "ğŸšª ç©å®¶è¿›å‡º", Config.Colors.Secondary)
    mkToggle(UI.panelFilter, 140, "SYS_STATS",     "ğŸ“Š ç»Ÿè®¡è¾“å‡º", Config.Colors.Accent)
    mkToggle(UI.panelFilter, 172, "SYS_SAVE",      "ğŸ’¾ ä¿å­˜", Config.Colors.Success)
    mkToggle(UI.panelFilter, 204, "SYS_EXPORT",    "ğŸ“¤ å¯¼å‡º/å¤åˆ¶", Color3.fromRGB(0,150,255))
    mkToggle(UI.panelFilter, 236, "SYS_HINT",      "ğŸ’¡ æç¤º", Config.Colors.Accent)

    -- menu toggles
    local function mkMini(parent, y, key, label)
        local row=Instance.new("TextButton")
        row.Size=UDim2.new(1,-12,0,28)
        row.Position=UDim2.new(0,6,0,y)
        row.BackgroundColor3=Color3.fromRGB(0,0,0)
        row.BackgroundTransparency=0.55
        row.BorderSizePixel=0
        row.Text=""
        row.Parent=parent

        local txt=Instance.new("TextLabel")
        txt.BackgroundTransparency=1
        txt.Size=UDim2.new(1,-60,1,0)
        txt.Position=UDim2.new(0,10,0,0)
        txt.TextXAlignment=Enum.TextXAlignment.Left
        txt.Font=Enum.Font.GothamBold
        txt.TextSize=13
        txt.TextColor3=Color3.new(1,1,1)
        txt.Text=label
        txt.Parent=row

        local tag=Instance.new("TextLabel")
        tag.BackgroundTransparency=1
        tag.Size=UDim2.new(0,50,1,0)
        tag.Position=UDim2.new(1,-54,0,0)
        tag.Font=Enum.Font.GothamBold
        tag.TextSize=12
        tag.TextColor3=Color3.new(1,1,1)
        tag.Parent=row

        local function refresh() tag.Text = Features[key] and "ON" or "OFF" end
        refresh()

        row.MouseButton1Click:Connect(function()
            Features[key]=not Features[key]
            refresh()
            updateInfo()
        end)
    end

    mkMini(UI.panelMenu, 44,  "showPlayers",  "ğŸ‘¥ åœ¨çº¿äººæ•°")
    mkMini(UI.panelMenu, 76,  "showRuntime",  "â±ï¸ è¿è¡Œæ—¶é—´")
    mkMini(UI.panelMenu, 108, "showWordCount","ğŸ“š å­—åº“è¯æ•°")
    mkMini(UI.panelMenu, 140, "showSwearRate","ğŸ¤¬ è„è¯ç‡(è¿‘çª—)")
    mkMini(UI.panelMenu, 172, "smoothAnimations","ğŸ§ˆ åŠ¨ç”»")

    -- bind
    search:GetPropertyChangedSignal("Text"):Connect(function()
        UI.filterText = string.lower(search.Text or "")
        renderAll()
    end)

    btnMenu.MouseButton1Click:Connect(function()
        if state.isCollapsed then return end
        UI.panelMenu.Visible = not UI.panelMenu.Visible
        if UI.panelMenu.Visible then UI.panelFilter.Visible=false end
    end)

    btnFilter.MouseButton1Click:Connect(function()
        if state.isCollapsed then return end
        UI.panelFilter.Visible = not UI.panelFilter.Visible
        if UI.panelFilter.Visible then UI.panelMenu.Visible=false end
    end)

    btnHide.MouseButton1Click:Connect(function()
        state.uiVisible = not state.uiVisible
        if uiAlive() then UI.main.Visible = state.uiVisible end
        btnHide.Text = state.uiVisible and "âœ–" or "â—‰"
    end)

    btnFoldTop.MouseButton1Click:Connect(function()
        state.isCollapsed = not state.isCollapsed
        applyCollapsedUI()
    end)

    bPeople.MouseButton1Click:Connect(function()
        if state.isCollapsed then return end
        UI.panelPeople.Visible = not UI.panelPeople.Visible
        if UI.panelPeople.Visible then rebuildPeopleList(peopleList) end
        UI.panelMenu.Visible=false
        UI.panelFilter.Visible=false
    end)

    -- drag
    local dragging=false
    local dragOffset=Vector2.new()
    titleBar.InputBegan:Connect(function(input)
        if input.UserInputType==Enum.UserInputType.MouseButton1 or input.UserInputType==Enum.UserInputType.Touch then
            dragging=true
            dragOffset=Vector2.new(input.Position.X-main.AbsolutePosition.X, input.Position.Y-main.AbsolutePosition.Y)
        end
    end)
    titleBar.InputEnded:Connect(function(input)
        if input.UserInputType==Enum.UserInputType.MouseButton1 or input.UserInputType==Enum.UserInputType.Touch then dragging=false end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if not dragging or not uiAlive() then return end
        if input.UserInputType==Enum.UserInputType.MouseMovement or input.UserInputType==Enum.UserInputType.Touch then
            main.Position=UDim2.new(0, input.Position.X-dragOffset.X, 0, input.Position.Y-dragOffset.Y)
        end
    end)

    -- resize
    local resizing=false
    local rs=Vector2.new()
    local rsz=Vector2.new()
    handle.InputBegan:Connect(function(input)
        if state.isCollapsed then return end
        if input.UserInputType==Enum.UserInputType.MouseButton1 or input.UserInputType==Enum.UserInputType.Touch then
            resizing=true
            rs=Vector2.new(input.Position.X, input.Position.Y)
            rsz=Vector2.new(main.AbsoluteSize.X, main.AbsoluteSize.Y)
            handle.BackgroundTransparency=0.2
        end
    end)
    handle.InputEnded:Connect(function(input)
        if input.UserInputType==Enum.UserInputType.MouseButton1 or input.UserInputType==Enum.UserInputType.Touch then
            resizing=false
            handle.BackgroundTransparency=0.45
        end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if not resizing or state.isCollapsed or not uiAlive() then return end
        if input.UserInputType==Enum.UserInputType.MouseMovement or input.UserInputType==Enum.UserInputType.Touch then
            local d=Vector2.new(input.Position.X-rs.X, input.Position.Y-rs.Y)
            state.width = clamp(rsz.X+d.X, Config.MinWidth, Config.MaxWidth)
            state.height= clamp(rsz.Y+d.Y, Config.MinHeight, Config.MaxHeight)
            main.Size=UDim2.new(0,state.width,0,state.height)
            setPinnedPosition()
        end
    end)

    -- actions
    bSave.MouseButton1Click:Connect(function()
        if state.isSaving then addSystem("æ­£åœ¨ä¿å­˜ä¸­...", "SYS_SAVE") return end
        bSave.Text="â³..."
        bSave.BackgroundColor3=Color3.fromRGB(255,165,0)
        saveToFileAsync(function(ok,err)
            if ok then addSystem("ä¿å­˜æˆåŠŸ","SYS_SAVE"); bSave.Text="âœ…"; bSave.BackgroundColor3=Config.Colors.Success
            else addSystem("ä¿å­˜å¤±è´¥ - "..tostring(err),"SYS_SAVE"); bSave.Text="âŒ"; bSave.BackgroundColor3=Config.Colors.Danger end
            task.wait(1.0)
            bSave.Text="ğŸ’¾ä¿å­˜"; bSave.BackgroundColor3=Config.Colors.Success
        end)
    end)

    bExport.MouseButton1Click:Connect(function()
        saveToFileAsync(function(ok,err)
            if ok then addSystem("å¯¼å‡ºæˆåŠŸï¼ˆå·²ä¿å­˜æ–‡ä»¶ï¼‰","SYS_EXPORT")
            else addSystem("å¯¼å‡ºå¤±è´¥ - "..tostring(err),"SYS_EXPORT") end
        end)
    end)

    bCopy.MouseButton1Click:Connect(function()
        local all=table.concat(state.chatHistory,"\n")
        if setclipboard then
            pcall(function() setclipboard(all) end)
            addSystem(("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼ˆ%dæ¡ï¼‰"):format(#state.chatHistory),"SYS_EXPORT")
        else
            addSystem("å½“å‰ç¯å¢ƒä¸æ”¯æŒ setclipboard","SYS_EXPORT")
        end
    end)

    bStats.MouseButton1Click:Connect(function()
        local bz=computeBaZhi()
        local lvl=select(1,getBaZhiLevel(bz))
        addSystem("â•â•â•â• è¿‘çª—ç»Ÿè®¡(Detector) â•â•â•â•","SYS_STATS")
        addSystem(("ç‹‚æš´å€¼ï¼š%d%% ç­‰çº§ï¼š%s"):format(bz,lvl),"SYS_STATS")
        addSystem(("è„è¯ç‡(è¿‘çª—)ï¼š%d%% | Detector:%s | å­—åº“:%d")
            :format(getSwearRateWindow(), det and "ON" or "OFF", totalWordCount), "SYS_STATS")
    end)

    bFont.MouseButton1Click:Connect(function()
        local sizes={14,18,22,26}
        local idx=1
        for i,s in ipairs(sizes) do if state.fontSize==s then idx=i break end end
        state.fontSize = sizes[idx%#sizes+1]
        addSystem("å­—ä½“å¤§å° = "..tostring(state.fontSize),"SYS_HINT")
        renderAll(); updateInfo()
    end)

    bClear.MouseButton1Click:Connect(function()
        state.chatHistory={}
        state.renderQueue={}
        Window.items={}
        state.messageStats={}
        addSystem("å·²æ¸…ç©ºè®°å½•/è¿‘çª—ç»Ÿè®¡","SYS_HINT")
        renderAll(); updateInfo()
    end)

    local pinCycle={"BR","TR","TL","BL"} local pinIndex=1
    bPin.MouseButton1Click:Connect(function()
        pinIndex = pinIndex%#pinCycle+1
        state.pinned = pinCycle[pinIndex]
        setPinnedPosition()
        addSystem("ç½®é¡¶ä½ç½® = "..state.pinned,"SYS_HINT")
    end)

    bClose.MouseButton1Click:Connect(function()
        if UI.gui then UI.gui:Destroy() end
        UI.gui=nil; UI.main=nil; UI.scroll=nil
        addSystem("UIå·²å…³é—­ï¼ˆåå°ç»§ç»­è®°å½•ï¼‰","SYS_HINT")
    end)

    -- join/leave logs
    Players.PlayerAdded:Connect(function(p)
        addSystem(p.Name.." åŠ å…¥äº†æ¸¸æˆ","SYS_JOINLEAVE")
        if uiAlive() and UI.panelPeople.Visible then rebuildPeopleList(peopleList) end
    end)
    Players.PlayerRemoving:Connect(function(p)
        addSystem(p.Name.." ç¦»å¼€äº†æ¸¸æˆ","SYS_JOINLEAVE")
        if uiAlive() and UI.panelPeople.Visible then rebuildPeopleList(peopleList) end
    end)

    setPinnedPosition()
    updateInfo()
    addSystem(("å¯åŠ¨å®Œæˆï¼šDetector=%s | å­—åº“è¯æ•°=%d"):format(det and "ON" or "OFF", totalWordCount),"SYS_START")
    renderAll()
    applyCollapsedUI()
end

-- ===== Ticker / AutoSave =====
local function startTicker()
    local interval=1/Config.StatsUpdateHz
    local acc=0
    RunService.Heartbeat:Connect(function(dt)
        acc += dt
        if acc >= interval then acc=0; updateInfo() end
    end)
end

local function startAutoSave()
    task.spawn(function()
        while true do
            task.wait(Config.AutoSaveInterval)
            if #state.chatHistory>0 and not state.isSaving then
                saveToFileAsync(function(ok)
                    if ok then addSystem("è‡ªåŠ¨ä¿å­˜å®Œæˆ","SYS_SAVE") end
                end)
            end
        end
    end)
end

-- ===== Chat capture (ä¸è¦†ç›– OnIncomingMessage) + å»é‡ =====
local Dedup = {}
local DEDUP_WINDOW = 0.35
local function dedupKey(speaker, text) return tostring(speaker or "nil").."â”‚"..tostring(text or "") end
local function passDedup(speaker, text)
    local t=os.clock()
    local k=dedupKey(speaker,text)
    local last=Dedup[k]
    Dedup[k]=t
    if math.random(1,20)==5 then
        for kk,vt in pairs(Dedup) do if (t-vt)>2.0 then Dedup[kk]=nil end end
    end
    return (last==nil) or ((t-last)>DEDUP_WINDOW)
end

local function onCaptured(speaker, text, src)
    if type(text)~="string" or text=="" then return end
    if not passDedup(speaker, text) then return end
    addChat(speaker or "æœªçŸ¥", text)
end

local function hookTCS_MessageReceived()
    if not TextChatService then return false end
    local ok, ver = pcall(function() return TextChatService.ChatVersion end)
    if not ok or ver ~= Enum.ChatVersion.TextChatService then return false end
    if typeof(TextChatService.MessageReceived) ~= "RBXScriptSignal" then return false end

    TextChatService.MessageReceived:Connect(function(msg)
        local speaker="æœªçŸ¥"
        local text=""
        pcall(function()
            text = msg.Text or ""
            if msg.TextSource and msg.TextSource.UserId then
                local p = Players:GetPlayerByUserId(msg.TextSource.UserId)
                if p then speaker = p.Name end
            end
        end)
        onCaptured(speaker, text, "TCS")
    end)
    addSystem("èŠå¤©æºï¼šTCS.MessageReceived âœ…","SYS_CHATFLOW")
    return true
end

local function hookDefaultChatEvents()
    local ev = ReplicatedStorage:FindFirstChild("DefaultChatSystemChatEvents")
    if not ev then return false end
    local r = ev:FindFirstChild("OnMessageDoneFiltering")
    if not r or not r:IsA("RemoteEvent") then return false end

    r.OnClientEvent:Connect(function(md)
        local speaker = (type(md)=="table" and (md.FromSpeaker or md.FromSpeakerName)) or "æœªçŸ¥"
        local text = (type(md)=="table" and (md.Message or md.MessageText)) or ""
        onCaptured(speaker, tostring(text or ""), "DefaultChatEvents")
    end)
    addSystem("èŠå¤©æºï¼šDefaultChatEvents âœ…","SYS_CHATFLOW")
    return true
end

local function hookLegacyChatted()
    local function bind(p)
        p.Chatted:Connect(function(msg)
            onCaptured(p.Name, msg, "Chatted")
        end)
    end
    for _,p in ipairs(Players:GetPlayers()) do bind(p) end
    Players.PlayerAdded:Connect(bind)
    addSystem("èŠå¤©æºï¼šPlayer.Chatted âœ…","SYS_CHATFLOW")
    return true
end

-- ===== Boot =====
createUI()
startTicker()
startAutoSave()

local any=false
any = hookTCS_MessageReceived() or any
any = hookDefaultChatEvents() or any
any = hookLegacyChatted() or any

if not any then
    addSystem("âš ï¸ æœªæ£€æµ‹åˆ°å¯ç”¨èŠå¤©æºï¼šè¯¥æ¸¸æˆå¯èƒ½å®Œå…¨è‡ªå®šä¹‰èŠå¤©UIï¼ˆä¸èµ°é»˜è®¤ç®¡çº¿ï¼‰","SYS_CHATFLOW")
end
