-- è´´å§ç‹‚æš´è®°å½•å™¨ v1.0.6 FINALï¼ˆç¨³å®šç‰ˆï¼‰
-- âœ… ### å¿…è®¡è„è¯ï¼ˆæ— è®º Detector æ˜¯å¦ ONï¼‰
-- âœ… Detector UTF-8 å´©æºƒå…œåº•ï¼ˆinvalid UTF-8 code ä¸ä¼šè®© Detector ç›´æ¥ OFFï¼‰
-- âœ… æ‹–æ‹½/ç¼©æ”¾ä¸å¸è§’ï¼ˆåªæœ‰æŒ‰ğŸ“Œç½®é¡¶æ‰å¸è§’ï¼›æ‹–/ç¼©ä¼šè‡ªåŠ¨å–æ¶ˆç½®é¡¶ï¼‰
-- âœ… ä¸‰è·¯æŠ“èŠå¤©ï¼šTCS.MessageReceived + DefaultChatSystemChatEvents + Player.Chatted
-- âœ… ç©å®¶è¿›å‡ºè®°å½•
-- âœ… æœç´¢è¿‡æ»¤/å¤åˆ¶/ä¿å­˜/æ¸…ç©º/ç»Ÿè®¡/é™éŸ³åå•/æŠ˜å å±•å¼€/ç½®é¡¶

repeat task.wait() until game:GetService("Players").LocalPlayer

local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local okTCS, TextChatService = pcall(function() return game:GetService("TextChatService") end)
if not okTCS then TextChatService = nil end

local lp = Players.LocalPlayer
local pg = lp:WaitForChild("PlayerGui")

--========================
-- ä½ å¯é€‰ï¼šDetector/å­—åº“ï¼ˆä¸å¡«ä¹Ÿèƒ½è·‘ï¼‰
--========================
local DETECTOR_URL    = "https://raw.githubusercontent.com/dtbile/-/main/æ£€æµ‹å¼•æ“.txt" -- ä½ çš„ Detector.lua rawï¼ˆreturn Detectorï¼‰ï¼Œä¸å¡«å°±çº¯æœ¬åœ°è§„åˆ™
local WORDS_TABLE_URL = "https://raw.githubusercontent.com/dtbile/-/refs/heads/main/words.lua" -- ä½ çš„ words.lua rawï¼ˆreturn tableï¼‰ï¼Œä¸å¡«å°±ç”¨å†…ç½® fallback

--========================
-- Config
--========================
local C = {
	Version = "v1.0.6",
	FileName = "è´´å§èŠå¤©è®°å½•.txt",

	MaxHistory = 4000,
	MaxRender = 320,
	RenderQueueMax = 1600,

	DefaultWidth = 560,
	DefaultHeight = 760,
	MinWidth = 360,
	MinHeight = 240,
	MaxWidth = 980,
	MaxHeight = 1100,
	CollapsedHeight = 96,

	StatsHz = 4,
	WindowSeconds = 180,
	WindowMax = 180,
	BurstSeconds = 4,

	FontSize = 18,

	Colors = {
		Primary   = Color3.fromRGB(255,45,85),
		Secondary = Color3.fromRGB(0,255,255),
		Accent    = Color3.fromRGB(255,215,0),
		Bg        = Color3.fromRGB(6,6,14),
		Panel     = Color3.fromRGB(14,14,24),
		Text      = Color3.fromRGB(245,245,245),
		System    = Color3.fromRGB(255,215,0),
		Muted     = Color3.fromRGB(140,140,140),
		Danger    = Color3.fromRGB(255,70,70),
		Success   = Color3.fromRGB(0,200,0),
		Dim       = Color3.fromRGB(170,170,170),
	},
}

local function clamp(n,a,b) if n<a then return a elseif n>b then return b else return n end end
local function nowStr() return os.date("%Y-%m-%d %H:%M:%S") end
local function tween(obj,t,props)
	if not obj then return end
	TweenService:Create(obj, TweenInfo.new(t, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), props):Play()
end

--========================
-- UTF8 æ¸…æ´—ï¼šé˜² Detector.new invalid UTF-8 code
--========================
local function sanitizeUtf8(s)
	if type(s)~="string" or s=="" then return "" end
	local out={}
	local i=1
	local n=#s
	while i<=n do
		local b=s:byte(i)
		if b<0x80 then
			out[#out+1]=string.char(b); i+=1
		else
			local len
			if b>=0xC2 and b<=0xDF then len=2
			elseif b>=0xE0 and b<=0xEF then len=3
			elseif b>=0xF0 and b<=0xF4 then len=4
			else i+=1; goto continue end
			if i+len-1>n then break end
			local ok=true
			for j=1,len-1 do
				local bb=s:byte(i+j)
				if not bb or bb<0x80 or bb>0xBF then ok=false break end
			end
			if ok then out[#out+1]=s:sub(i,i+len-1); i+=len else i+=1 end
		end
		::continue::
	end
	return table.concat(out)
end

local function safeHttpGet(url)
	if not url or url=="" then return nil, "empty url" end
	local ok, src = pcall(function() return game:HttpGet(url) end)
	if not ok or type(src)~="string" then return nil, "httpget failed" end
	if src:sub(1,1)=="<" and src:lower():find("<html",1,true) then
		return nil, "got html (bad raw url / redirect)"
	end
	return src, nil
end

local function safeLoadFromUrl(url)
	local src, err = safeHttpGet(url)
	if not src then return nil, err end
	local ok2, mod = pcall(function() return loadstring(src)() end)
	if not ok2 then return nil, "loadstring failed" end
	return mod, nil
end

--========================
-- Fallback å­—åº“ï¼ˆDetector OFF ä¹Ÿèƒ½è®¡ï¼‰
--========================
local FALLBACK_WORDS = {
	chinese_basic={"è‰","æ“","è‰¹","è‚","æ—¥","é ","æ»š","çˆ¬","æ€¼","æ·¦","å¦ˆ","çˆ¹","çˆ·","å‚»é€¼","åƒåœ¾","åºŸç‰©","ç‹—å±","ç‹—å±","æ‰¯æ·¡","æ¶å¿ƒ","æ²™é›•"},
	pinyin_abbrev={"sb","cnm","nmsl","tmd","wdnmd","mlgb","wqnmlgb"},
	leet={"c4o","ca0","f**k","fuk","fk","sh1t","b1tch","bi7ch"},
}

local function sanitizeWordsTable(words)
	local cleaned={}
	for cat,list in pairs(words) do
		if type(list)=="table" then
			local nl={}
			for i=1,#list do
				local w=list[i]
				if type(w)=="string" then
					local w2=sanitizeUtf8(w)
					if w2~="" then nl[#nl+1]=w2 end
				end
			end
			cleaned[cat]=nl
		end
	end
	return cleaned
end

local wordsTable = FALLBACK_WORDS
do
	if WORDS_TABLE_URL ~= "" then
		local wt = select(1, safeLoadFromUrl(WORDS_TABLE_URL))
		if type(wt)=="table" then wordsTable = wt end
	end
	wordsTable = sanitizeWordsTable(wordsTable)
end

local function countWords(tbl)
	local c=0
	for _,list in pairs(tbl) do if type(list)=="table" then c += #list end end
	return c
end

--========================
-- Detectorï¼ˆå¯é€‰ï¼‰
--========================
local Detector, det = nil, nil
local detectorStatus = "OFF"
do
	if DETECTOR_URL ~= "" then
		local mod = select(1, safeLoadFromUrl(DETECTOR_URL))
		if type(mod)=="table" and type(mod.new)=="function" and type(mod.scan)=="function" then
			Detector = mod
		end
	end
	if Detector then
		local ok, inst = pcall(function() return Detector.new(wordsTable) end)
		if ok then det=inst; detectorStatus="ON" end
	end
end

local function scanDetector(msg)
	if not det then return false, 0 end
	msg = sanitizeUtf8(msg)
	local ok, r = pcall(function() return det:scan(msg) end)
	if ok and type(r)=="table" then
		return r.hit==true, tonumber(r.score) or 0
	end
	return false, 0
end

--========================
-- State / Window stats
--========================
local S = {
	history={}, renderQ={},
	muted={},
	isCollapsed=false,
	pinEnabled=false,
	pinned="BR",
	width=C.DefaultWidth, height=C.DefaultHeight,
	fontSize=C.FontSize,
	startTime=os.time(),
}

local Window = { items={} } -- {t, meta}
local function windowPrune()
	local nowT=os.time()
	local cutoff=nowT-C.WindowSeconds
	while #Window.items>0 and Window.items[1].t < cutoff do table.remove(Window.items,1) end
	while #Window.items>C.WindowMax do table.remove(Window.items,1) end
end
local function windowAdd(meta)
	Window.items[#Window.items+1] = {t=os.time(), meta=meta}
	windowPrune()
end

--========================
-- åˆ†æï¼šä¿è¯ ### å¿…è®¡
--========================
local function analyzeMsg(msg)
	msg=tostring(msg or "")
	local hash = select(2, msg:gsub("#",""))
	local ex = select(2, msg:gsub("!","")) + select(2, msg:gsub("ï¼",""))
	local qu = select(2, msg:gsub("%?","")) + select(2, msg:gsub("ï¼Ÿ",""))

	-- âœ… ### / # å¿…è®¡
	if hash > 0 then
		return {swear=true, detScore=0, hash=hash, ex=ex, qu=qu}
	end

	local hit, score = scanDetector(msg)
	if hit then
		return {swear=true, detScore=score, hash=0, ex=ex, qu=qu}
	end

	-- fallbackï¼šç®€å•åŒ…å«ï¼ˆDetector OFF ä¹Ÿèƒ½ç»Ÿè®¡ï¼‰
	local lower = string.lower(msg)
	for _,list in pairs(wordsTable) do
		if type(list)=="table" then
			for i=1,#list do
				local w=list[i]
				if type(w)=="string" and w~="" then
					if lower:find(string.lower(w),1,true) then
						return {swear=true, detScore=0, hash=0, ex=ex, qu=qu}
					end
				end
			end
		end
	end

	return {swear=false, detScore=0, hash=0, ex=ex, qu=qu}
end

local function computeStats()
	windowPrune()
	local n=#Window.items
	if n<2 then return 0,0,0.0,0 end
	local swear=0
	local detSum,hashSum,exSum,quSum=0,0,0,0
	for i=1,n do
		local a=Window.items[i].meta
		if a.swear then swear+=1 end
		detSum += a.detScore or 0
		hashSum += a.hash or 0
		exSum += a.ex or 0
		quSum += a.qu or 0
	end
	local swearPct = math.floor((swear/n)*100)
	local span = math.max(1, Window.items[n].t - Window.items[1].t)
	local mps = n/span
	local burst=0
	do
		local t0=Window.items[n].t
		local c=0
		for i=n,1,-1 do
			if (t0-Window.items[i].t) <= C.BurstSeconds then c+=1 else break end
		end
		burst=c
	end
	local score=0
	score += clamp((swear/n)*120,0,60)
	score += clamp((mps/1.8)*12,0,12)
	score += clamp((burst/7)*8,0,8)
	score += clamp(((exSum+quSum)/n)*2.2,0,10)
	score += clamp((hashSum/n)*4.0,0,10)
	score += clamp(((detSum/n)/10)*4,0,4)
	return math.floor(clamp(score,0,100)), swearPct, mps, burst
end

local function levelName(v)
	if v<20 then return "ğŸ•Šï¸ å’Œå¹³é¸½", Color3.fromRGB(100,255,100) end
	if v<40 then return "ğŸ˜ èŒæ–°", Color3.fromRGB(200,255,100) end
	if v<60 then return "ğŸ˜¤ æš´èºè€å“¥", Color3.fromRGB(255,200,100) end
	if v<80 then return "ğŸ¤¬ è´´å§æˆ˜ç¥", Color3.fromRGB(255,100,100) end
	return "ğŸ’€ ç‹‚æš´ã®ç¥", Color3.fromRGB(255,50,50)
end

--========================
-- UI
--========================
local UI = {filterText=""}
local function uiAlive() return UI.gui and UI.main and UI.main.Parent~=nil end

local function pushHistory(line)
	S.history[#S.history+1]=line
	if #S.history>C.MaxHistory then table.remove(S.history,1) end
end

local function pushRender(entry)
	S.renderQ[#S.renderQ+1]=entry
	if #S.renderQ>C.RenderQueueMax then table.remove(S.renderQ,1) end
end

function UI.renderAll()
	if not uiAlive() or S.isCollapsed then return end
	for _,c in ipairs(UI.scroll:GetChildren()) do
		if c:IsA("TextLabel") or c:IsA("UIListLayout") then c:Destroy() end
	end
	local layout=Instance.new("UIListLayout")
	layout.Padding=UDim.new(0,4)
	layout.SortOrder=Enum.SortOrder.LayoutOrder
	layout.Parent=UI.scroll
	layout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
		if uiAlive() then UI.scroll.CanvasSize=UDim2.new(0,0,0,layout.AbsoluteContentSize.Y+10) end
	end)

	local f=UI.filterText
	local shown=0
	local start=math.max(1,#S.renderQ-C.RenderQueueMax+1)
	for i=start,#S.renderQ do
		local e=S.renderQ[i]
		if e then
			if f=="" or string.find(string.lower(e.text), f, 1, true) then
				local lbl=Instance.new("TextLabel")
				lbl.BackgroundTransparency=1
				lbl.Size=UDim2.new(1,-10,0,0)
				lbl.AutomaticSize=Enum.AutomaticSize.Y
				lbl.TextWrapped=true
				lbl.TextXAlignment=Enum.TextXAlignment.Left
				lbl.TextYAlignment=Enum.TextYAlignment.Top
				lbl.Font=Enum.Font.SourceSans
				lbl.TextSize=S.fontSize
				lbl.TextColor3=e.color or C.Colors.Text
				lbl.Text=e.text
				lbl.Parent=UI.scroll
				shown += 1
				if shown>=C.MaxRender then break end
			end
		end
	end
	task.defer(function()
		if uiAlive() then UI.scroll.CanvasPosition=Vector2.new(0,1e9) end
	end)
end

local function addLine(raw, cat, color)
	local line = ("[%s] %s"):format(nowStr(), raw)
	pushHistory(line)
	pushRender({text=line, cat=cat, color=color})

	if not uiAlive() or S.isCollapsed then return end
	if UI.filterText~="" then UI.renderAll(); return end

	local lbl=Instance.new("TextLabel")
	lbl.BackgroundTransparency=1
	lbl.Size=UDim2.new(1,-10,0,0)
	lbl.AutomaticSize=Enum.AutomaticSize.Y
	lbl.TextWrapped=true
	lbl.TextXAlignment=Enum.TextXAlignment.Left
	lbl.TextYAlignment=Enum.TextYAlignment.Top
	lbl.Font=Enum.Font.SourceSans
	lbl.TextSize=S.fontSize
	lbl.TextColor3=color or C.Colors.Text
	lbl.Text=line
	lbl.Parent=UI.scroll

	task.defer(function()
		if uiAlive() then UI.scroll.CanvasPosition=Vector2.new(0,1e9) end
	end)
end

local function sys(msg) addLine("ğŸ§  ç³»ç»Ÿï¼š"..msg, "SYS", C.Colors.System) end

local function setPinnedIfEnabled()
	if not uiAlive() or not S.pinEnabled then return end
	local pad=10
	local w=S.width
	local h=S.isCollapsed and C.CollapsedHeight or S.height
	if S.pinned=="BR" then UI.main.Position=UDim2.new(1,-w-pad,1,-h-pad)
	elseif S.pinned=="TR" then UI.main.Position=UDim2.new(1,-w-pad,0,pad)
	elseif S.pinned=="BL" then UI.main.Position=UDim2.new(0,pad,1,-h-pad)
	else UI.main.Position=UDim2.new(0,pad,0,pad) end
end

local function updateInfo()
	if not uiAlive() then return end
	local bz, swearPct, mps, burst = computeStats()
	local lvl,col = levelName(bz)
	UI.info.Text = ("ğŸ‘¥%d | %s %d%% | ğŸ¤¬%d%% | âš¡%.2f/s | ğŸ’¥%d | ğŸ“š%d | Detector:%s")
		:format(#Players:GetPlayers(), lvl, bz, swearPct, mps, burst, countWords(wordsTable), detectorStatus)
	UI.info.TextColor3 = col
end

--========================
-- Build UIï¼ˆä¸é‡å ï¼šå³ä¸ŠæŒ‰é’®ç”¨ UIListLayoutï¼‰
--========================
do
	local old=pg:FindFirstChild("ChatLoggerGUI")
	if old then old:Destroy() end

	local gui=Instance.new("ScreenGui")
	gui.Name="ChatLoggerGUI"
	gui.ResetOnSpawn=false
	gui.Parent=pg
	UI.gui=gui

	local main=Instance.new("Frame")
	main.Size=UDim2.new(0,S.width,0,S.height)
	main.Position=UDim2.new(0,20,0,100)
	main.BackgroundColor3=C.Colors.Bg
	main.BackgroundTransparency=0.08
	main.BorderSizePixel=0
	main.ClipsDescendants=true
	main.Active=true
	main.Parent=gui
	UI.main=main

	local stroke=Instance.new("UIStroke")
	stroke.Thickness=2
	stroke.Color=C.Colors.Primary
	stroke.Transparency=0.15
	stroke.Parent=main

	local titleBar=Instance.new("Frame")
	titleBar.Size=UDim2.new(1,0,0,86)
	titleBar.BackgroundColor3=C.Colors.Primary
	titleBar.BackgroundTransparency=0.22
	titleBar.BorderSizePixel=0
	titleBar.Parent=main
	UI.titleBar=titleBar

	local title=Instance.new("TextLabel")
	title.BackgroundTransparency=1
	title.Size=UDim2.new(1,-12,0,40)
	title.Position=UDim2.new(0,12,0,0)
	title.TextXAlignment=Enum.TextXAlignment.Left
	title.Font=Enum.Font.GothamBold
	title.TextSize=S.fontSize+3
	title.TextColor3=Color3.new(1,1,1)
	title.Text="ğŸ’€ è´´å§ç‹‚æš´è®°å½•å™¨ "..C.Version
	title.Parent=titleBar

	local right=Instance.new("Frame")
	right.BackgroundTransparency=1
	right.Size=UDim2.new(0,220,0,40)
	right.Position=UDim2.new(1,-230,0,0)
	right.Parent=titleBar
	local rl=Instance.new("UIListLayout")
	rl.FillDirection=Enum.FillDirection.Horizontal
	rl.HorizontalAlignment=Enum.HorizontalAlignment.Right
	rl.VerticalAlignment=Enum.VerticalAlignment.Center
	rl.Padding=UDim.new(0,6)
	rl.Parent=right

	local function topBtn(text,bg,tc)
		local b=Instance.new("TextButton")
		b.Size=UDim2.new(0,40,0,40)
		b.BackgroundColor3=bg
		b.BackgroundTransparency=0.2
		b.BorderSizePixel=0
		b.Text=text
		b.TextSize=20
		b.Font=Enum.Font.GothamBold
		b.TextColor3=tc or Color3.new(0,0,0)
		b.Parent=right
		return b
	end

	local btnHide = topBtn("âœ–", Color3.fromRGB(255,255,255), Color3.new(0,0,0))
	local btnFold = topBtn("â–¼", Color3.fromRGB(255,255,255), Color3.new(0,0,0))
	local btnPin  = topBtn("ğŸ“Œ", Color3.fromRGB(255,255,255), Color3.new(0,0,0))
	local btnTest = topBtn("ğŸ§ª", Color3.fromRGB(255,255,255), Color3.new(0,0,0))

	local search=Instance.new("TextBox")
	search.Size=UDim2.new(0,220,0,28)
	search.Position=UDim2.new(1,-470,0,6)
	search.BackgroundColor3=Color3.fromRGB(0,0,0)
	search.BackgroundTransparency=0.35
	search.TextColor3=Color3.new(1,1,1)
	search.PlaceholderText="ğŸ” æœç´¢è¿‡æ»¤..."
	search.ClearTextOnFocus=false
	search.Font=Enum.Font.SourceSans
	search.TextSize=14
	search.BorderSizePixel=0
	search.Parent=titleBar
	UI.search=search

	local scroll=Instance.new("ScrollingFrame")
	scroll.Size=UDim2.new(1,-20,1,-210)
	scroll.Position=UDim2.new(0,10,0,94)
	scroll.BackgroundColor3=Color3.new(0,0,0)
	scroll.BackgroundTransparency=0.45
	scroll.BorderSizePixel=0
	scroll.ScrollBarThickness=8
	scroll.ScrollBarImageColor3=C.Colors.Secondary
	scroll.Parent=main
	UI.scroll=scroll

	local layout=Instance.new("UIListLayout")
	layout.Padding=UDim.new(0,4)
	layout.SortOrder=Enum.SortOrder.LayoutOrder
	layout.Parent=scroll
	layout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
		if uiAlive() then scroll.CanvasSize=UDim2.new(0,0,0,layout.AbsoluteContentSize.Y+10) end
	end)

	local bar=Instance.new("Frame")
	bar.Size=UDim2.new(1,-20,0,96)
	bar.Position=UDim2.new(0,10,1,-132)
	bar.BackgroundTransparency=1
	bar.Parent=main

	local grid=Instance.new("UIGridLayout")
	grid.CellPadding=UDim2.new(0,8,0,8)
	grid.CellSize=UDim2.new(0,(S.width-40)/5,0,36)
	grid.Parent=bar

	local function mkBtn(text,bg)
		local b=Instance.new("TextButton")
		b.BackgroundColor3=bg
		b.BackgroundTransparency=0.18
		b.BorderSizePixel=0
		b.Text=text
		b.TextColor3=Color3.new(1,1,1)
		b.TextSize=S.fontSize-2
		b.Font=Enum.Font.GothamBold
		b.Parent=bar
		return b
	end

	local bSave=mkBtn("ğŸ’¾ä¿å­˜", C.Colors.Success)
	local bCopy=mkBtn("ğŸ“‹å¤åˆ¶", Color3.fromRGB(120,120,120))
	local bStats=mkBtn("ğŸ“Šç»Ÿè®¡", Color3.fromRGB(150,0,255))
	local bClear=mkBtn("ğŸ—‘ï¸æ¸…ç©º", Color3.fromRGB(255,100,0))
	local bClose=mkBtn("â»å…³é—­", C.Colors.Danger)

	local info=Instance.new("TextLabel")
	info.Size=UDim2.new(1,-20,0,22)
	info.Position=UDim2.new(0,10,1,-28)
	info.BackgroundTransparency=1
	info.TextXAlignment=Enum.TextXAlignment.Left
	info.Font=Enum.Font.SourceSansBold
	info.TextSize=S.fontSize-4
	info.TextColor3=C.Colors.Secondary
	info.Parent=main
	UI.info=info

	local handle=Instance.new("Frame")
	handle.Size=UDim2.new(0,20,0,20)
	handle.Position=UDim2.new(1,-20,1,-20)
	handle.BackgroundColor3=C.Colors.Secondary
	handle.BackgroundTransparency=0.45
	handle.BorderSizePixel=0
	handle.Parent=main
	UI.handle=handle

	search:GetPropertyChangedSignal("Text"):Connect(function()
		UI.filterText = string.lower(search.Text or "")
		UI.renderAll()
	end)

	btnHide.MouseButton1Click:Connect(function()
		main.Visible = not main.Visible
	end)

	btnFold.MouseButton1Click:Connect(function()
		S.isCollapsed = not S.isCollapsed
		if S.isCollapsed then
			btnFold.Text="â–²"
			tween(main,0.22,{Size=UDim2.new(0,S.width,0,C.CollapsedHeight)})
			scroll.Visible=false; bar.Visible=false; handle.Visible=false
		else
			btnFold.Text="â–¼"
			tween(main,0.22,{Size=UDim2.new(0,S.width,0,S.height)})
			scroll.Visible=true; bar.Visible=true; handle.Visible=true
			UI.renderAll()
		end
		setPinnedIfEnabled()
	end)

	local pinCycle={"BR","TR","TL","BL"} local pi=1
	btnPin.MouseButton1Click:Connect(function()
		pi = pi%#pinCycle + 1
		S.pinned = pinCycle[pi]
		S.pinEnabled = true
		setPinnedIfEnabled()
		sys("ğŸ“Œç½®é¡¶ï¼š"..S.pinned.."ï¼ˆæ‹–åŠ¨/ç¼©æ”¾ä¼šå–æ¶ˆï¼‰")
	end)

	btnTest.MouseButton1Click:Connect(function()
		sys("è‡ªæµ‹ï¼šæ’å…¥ ###ï¼ˆå¿…é¡»è®¡è„è¯ï¼‰")
		windowAdd(analyzeMsg("###"))
		addLine("TestUserï¼š###", "CHAT", C.Colors.Text)
		updateInfo()
	end)

	bStats.MouseButton1Click:Connect(function()
		local bz,sp,mps,burst = computeStats()
		local lvl=select(1,levelName(bz))
		sys(("è¿‘çª—ï¼š%d%%(%s) | è„è¯ç‡=%d%% | %.2f/s | burst=%d | Detector=%s")
			:format(bz,lvl,sp,mps,burst,detectorStatus))
	end)

	bSave.MouseButton1Click:Connect(function()
		if writefile then
			writefile(C.FileName, table.concat(S.history,"\n"))
			sys("ä¿å­˜å®Œæˆ")
		else
			sys("ç¯å¢ƒä¸æ”¯æŒ writefile")
		end
	end)

	bCopy.MouseButton1Click:Connect(function()
		if setclipboard then
			setclipboard(table.concat(S.history,"\n"))
			sys("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿")
		else
			sys("ç¯å¢ƒä¸æ”¯æŒ setclipboard")
		end
	end)

	bClear.MouseButton1Click:Connect(function()
		S.history={}; S.renderQ={}; Window.items={}
		sys("å·²æ¸…ç©º")
		UI.renderAll(); updateInfo()
	end)

	bClose.MouseButton1Click:Connect(function()
		gui:Destroy()
	end)

	-- drag / resizeï¼šéƒ½ä¼šå–æ¶ˆç½®é¡¶ï¼Œé¿å…â€œåŠ¨ä¸€ä¸‹å°±å¸è§’â€
	local dragging=false
	local dragOffset=Vector2.new()
	titleBar.InputBegan:Connect(function(input)
		if input.UserInputType==Enum.UserInputType.MouseButton1 or input.UserInputType==Enum.UserInputType.Touch then
			dragging=true
			dragOffset=Vector2.new(input.Position.X-main.AbsolutePosition.X, input.Position.Y-main.AbsolutePosition.Y)
			S.pinEnabled=false
		end
	end)
	titleBar.InputEnded:Connect(function(input)
		if input.UserInputType==Enum.UserInputType.MouseButton1 or input.UserInputType==Enum.UserInputType.Touch then dragging=false end
	end)
	UserInputService.InputChanged:Connect(function(input)
		if not dragging or not uiAlive() then return end
		if input.UserInputType==Enum.UserInputType.MouseMovement or input.UserInputType==Enum.UserInputType.Touch then
			main.Position=UDim2.new(0, input.Position.X-dragOffset.X, 0, input.Position.Y-dragOffset.Y)
		end
	end)

	local resizing=false
	local rs=Vector2.new()
	local rsz=Vector2.new()
	handle.InputBegan:Connect(function(input)
		if S.isCollapsed then return end
		if input.UserInputType==Enum.UserInputType.MouseButton1 or input.UserInputType==Enum.UserInputType.Touch then
			resizing=true
			rs=Vector2.new(input.Position.X,input.Position.Y)
			rsz=Vector2.new(main.AbsoluteSize.X,main.AbsoluteSize.Y)
			S.pinEnabled=false
		end
	end)
	handle.InputEnded:Connect(function(input)
		if input.UserInputType==Enum.UserInputType.MouseButton1 or input.UserInputType==Enum.UserInputType.Touch then resizing=false end
	end)
	UserInputService.InputChanged:Connect(function(input)
		if not resizing or S.isCollapsed or not uiAlive() then return end
		if input.UserInputType==Enum.UserInputType.MouseMovement or input.UserInputType==Enum.UserInputType.Touch then
			local d=Vector2.new(input.Position.X-rs.X, input.Position.Y-rs.Y)
			S.width = clamp(rsz.X+d.X, C.MinWidth, C.MaxWidth)
			S.height= clamp(rsz.Y+d.Y, C.MinHeight, C.MaxHeight)
			main.Size=UDim2.new(0,S.width,0,S.height)
			grid.CellSize=UDim2.new(0,(S.width-40)/5,0,36)
		end
	end)

	sys(("å¯åŠ¨å®Œæˆï¼šDetector=%s | å­—åº“=%d"):format(detectorStatus, countWords(wordsTable)))
	updateInfo()
end

--========================
-- Chat captureï¼ˆ3 è·¯ + å»é‡ï¼‰
--========================
local Dedup={}
local function passDedup(speaker,text)
	local t=os.clock()
	local k=tostring(speaker).."â”‚"..tostring(text)
	local last=Dedup[k]
	Dedup[k]=t
	return (not last) or ((t-last)>0.35)
end

local function onCaptured(speaker,text)
	if type(text)~="string" or text=="" then return end
	if not passDedup(speaker,text) then return end
	local raw = (speaker==lp.Name) and ("æˆ‘ï¼š"..text) or (tostring(speaker).."ï¼š"..text)
	local col = (S.muted[tostring(speaker)]==true) and C.Colors.Muted or C.Colors.Text
	addLine(raw, "CHAT", col)
	windowAdd(analyzeMsg(text))
	updateInfo()
end

local function hookTCS()
	if not TextChatService then return end
	local ok, ver = pcall(function() return TextChatService.ChatVersion end)
	if not ok or ver ~= Enum.ChatVersion.TextChatService then return end
	if typeof(TextChatService.MessageReceived) ~= "RBXScriptSignal" then return end
	TextChatService.MessageReceived:Connect(function(msg)
		local speaker="æœªçŸ¥"
		local text=""
		pcall(function()
			text = msg.Text or ""
			if msg.TextSource and msg.TextSource.UserId then
				local p=Players:GetPlayerByUserId(msg.TextSource.UserId)
				if p then speaker=p.Name end
			end
		end)
		onCaptured(speaker,text)
	end)
	sys("èŠå¤©æºï¼šTCS.MessageReceived âœ…")
end

local function hookDefault()
	local ev=ReplicatedStorage:FindFirstChild("DefaultChatSystemChatEvents")
	if not ev then return end
	local r=ev:FindFirstChild("OnMessageDoneFiltering")
	if not r or not r:IsA("RemoteEvent") then return end
	r.OnClientEvent:Connect(function(md)
		local speaker=(type(md)=="table" and (md.FromSpeaker or md.FromSpeakerName)) or "æœªçŸ¥"
		local text=(type(md)=="table" and (md.Message or md.MessageText)) or ""
		onCaptured(speaker, tostring(text or ""))
	end)
	sys("èŠå¤©æºï¼šDefaultChatEvents âœ…")
end

local function hookChatted()
	local function bind(p)
		p.Chatted:Connect(function(msg)
			onCaptured(p.Name, msg)
		end)
	end
	for _,p in ipairs(Players:GetPlayers()) do bind(p) end
	Players.PlayerAdded:Connect(bind)
	sys("èŠå¤©æºï¼šPlayer.Chatted âœ…")
end

hookTCS()
hookDefault()
hookChatted()

Players.PlayerAdded:Connect(function(p) sys(p.Name.." åŠ å…¥äº†æ¸¸æˆ") end)
Players.PlayerRemoving:Connect(function(p) sys(p.Name.." ç¦»å¼€äº†æ¸¸æˆ") end)

-- ticker
do
	local acc=0
	local interval=1/C.StatsHz
	RunService.Heartbeat:Connect(function(dt)
		acc += dt
		if acc>=interval then acc=0; updateInfo() end
	end)
end
