-- è´´å§ç‹‚æš´è®°å½•å™¨ v1.2.1 (Detector v5.1) + å¯é€‰ Detector
-- ç‰¹åˆ«ä¿®å¤ï¼š
-- 1) å½»åº•è§£å†³â€œå¤åˆ¶è¿‡é•¿/è¢«æˆªæ–­ â†’ Line 1 Incomplete statementâ€ï¼š
--    è¯·æŠŠæœ¬æ–‡ä»¶ä¸Šä¼ åˆ° GitHubï¼Œç„¶åç”¨ä¸‹é¢â€œLoader ä¸€é”®å¯åŠ¨â€åŠ è½½ã€‚
-- 2) ### / ä»»æ„åŒ…å« # çš„æ¶ˆæ¯ï¼šå¼ºåˆ¶è®¡ä¸ºâ€œè„è¯å‘½ä¸­â€
-- 3) Detector å­—åº“ UTF-8 åå­—èŠ‚ï¼šæ„å»ºå‰è‡ªåŠ¨æ¸…æ´—ï¼ˆé˜² invalid UTF-8 codeï¼‰
-- 4) resize ä¸å¸è§’ç¬ç§»ï¼šé»˜è®¤ pinEnabled=falseï¼›ç‚¹ğŸ“Œç½®é¡¶æ‰å¸è§’ï¼›æ‹–åŠ¨/ç¼©æ”¾è‡ªåŠ¨å–æ¶ˆç½®é¡¶
-- 5) èŠå¤©æŠ“å–ï¼šTextChatService.MessageReceived + DefaultChatSystemChatEvents + Player.Chattedï¼ˆä¸è¦†ç›– OnIncomingMessageï¼‰
--
-- Loaderï¼ˆæŠŠæœ¬æ–‡ä»¶æ”¾åˆ° github: main/tb_recorder.lua åï¼‰ï¼š
-- loadstring(game:HttpGet("https://raw.githubusercontent.com/<YOU>/<REPO>/main/tb_recorder.lua"))()

repeat task.wait() until game:GetService("Players").LocalPlayer

-- ===== Services =====
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local okTCS, TextChatService = pcall(function() return game:GetService("TextChatService") end)
if not okTCS then TextChatService = nil end

local lp = Players.LocalPlayer
local pg = lp:WaitForChild("PlayerGui")

-- ===== URLsï¼ˆå¯é€‰ï¼‰=====
-- å»ºè®®ï¼šDetector ç”¨ /main/ï¼Œåˆ«ç”¨ /refs/heads/
local DETECTOR_URL    = "https://raw.githubusercontent.com/dtbile/-/main/æ£€æµ‹å¼•æ“.txt" -- return Detector
local WORDS_TABLE_URL = "https://raw.githubusercontent.com/dtbile/-/main/words.lua"  -- ä½ çš„ words.lua rawï¼ˆreturn tableï¼‰ã€‚ç•™ç©ºåˆ™ fallback

-- ===== Config =====
local Config = {
    Version = "v1.2.1",
    FileName = "è´´å§èŠå¤©è®°å½•.txt",

    MaxHistory = 4000,
    MaxRender = 320,
    RenderQueueMax = 1600,
    AutoSaveInterval = 180,
    SaveTimeout = 3,

    DefaultWidth = 540,
    DefaultHeight = 760,
    MinWidth = 360,
    MinHeight = 220,
    MaxWidth = 980,
    MaxHeight = 1100,
    CollapsedHeight = 96,

    FontSize = 18,
    SmoothAnimations = true,
    StatsUpdateHz = 4,

    WindowSeconds = 180,
    WindowMaxMessages = 200,
    BurstSeconds = 4,
    SearchHideWidth = 620,
    DedupTTL = 8,
    CornerRadius = 14,

    Colors = {
        Primary   = Color3.fromRGB(255, 45, 85),
        Secondary = Color3.fromRGB(0, 255, 255),
        Accent    = Color3.fromRGB(255, 215, 0),
        Background= Color3.fromRGB(5, 5, 15),
        Panel     = Color3.fromRGB(12, 12, 20),
        Text      = Color3.fromRGB(255, 255, 255),
        System    = Color3.fromRGB(255, 215, 0),
        Muted     = Color3.fromRGB(130, 130, 130),
        Danger    = Color3.fromRGB(255, 60, 60),
        Success   = Color3.fromRGB(0, 200, 0),
        Dim       = Color3.fromRGB(160, 160, 160),
    }
}

local Features = {
    showPlayers = true,
    showRuntime = true,
    showWordCount = true,
    showSwearRate = true,
    smoothAnimations = true,
}

local CategoryFilter = {
    showCHAT = true,
    showSYSTEM = true,

    SYS_START = true,
    SYS_CHATFLOW = true,
    SYS_JOINLEAVE = true,
    SYS_STATS = true,
    SYS_SAVE = true,
    SYS_EXPORT = true,
    SYS_HINT = true,
}

-- ===== Utils =====
local function clamp(n,a,b) if n<a then return a elseif n>b then return b else return n end end
local function nowStr() return os.date("%Y-%m-%d %H:%M:%S") end
local function nz(x,d) if type(x)=="number" then return x else return d or 0 end end

local function tween(obj, t, props)
    if not obj then return end
    if not Config.SmoothAnimations or not Features.smoothAnimations then
        for k,v in pairs(props) do obj[k]=v end
        return
    end
    TweenService:Create(obj, TweenInfo.new(t, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), props):Play()
end

local function makeRound(inst, radius)
    local c = Instance.new("UICorner")
    c.CornerRadius = UDim.new(0, radius or Config.CornerRadius)
    c.Parent = inst
    return c
end

local function safeLoadFromUrl(url)
    if not url or url=="" then return nil, "empty url" end
    local ok, src = pcall(function() return game:HttpGet(url) end)
    if not ok or type(src)~="string" then return nil, "httpget failed" end
    if src:sub(1,1)=="<" and src:lower():find("<html",1,true) then
        return nil, "got html (redirect/404)"
    end
    local ok2, mod = pcall(function() return loadstring(src)() end)
    if not ok2 then return nil, "loadstring failed" end
    return mod, nil
end

-- ===== UTF-8 sanitize (prevents invalid UTF-8 code) =====
local function sanitizeUtf8(s)
    if type(s) ~= "string" or s == "" then return "" end
    local out = {}
    local i, n = 1, #s
    while i <= n do
        local b = s:byte(i)
        if b and b < 0x80 then
            out[#out+1] = string.char(b)
            i += 1
        else
            local len = nil
            if b and b >= 0xC2 and b <= 0xDF then len = 2
            elseif b and b >= 0xE0 and b <= 0xEF then len = 3
            elseif b and b >= 0xF0 and b <= 0xF4 then len = 4 end

            if not len then
                i += 1
            elseif i + len - 1 > n then
                break
            else
                local ok = true
                for j=1,len-1 do
                    local bb = s:byte(i+j)
                    if not bb or bb < 0x80 or bb > 0xBF then ok=false break end
                end
                if ok then
                    out[#out+1] = s:sub(i, i+len-1)
                    i += len
                else
                    i += 1
                end
            end
        end
    end
    return table.concat(out)
end

local function sanitizeWordsTable(words)
    local cleaned = {}
    local dropped = 0
    for cat, list in pairs(words) do
        if type(list)=="table" then
            local nl = {}
            for i=1,#list do
                local w = list[i]
                if type(w)=="string" then
                    local w2 = sanitizeUtf8(w)
                    if w2 ~= "" then nl[#nl+1]=w2 else dropped += 1 end
                else
                    dropped += 1
                end
            end
            cleaned[cat]=nl
        end
    end
    return cleaned, dropped
end

-- ===== Words fallback =====
local FALLBACK_WORDS = {
    chinese_basic = {"è‰","æ“","è‰¹","è‚","æ—¥","é ","æ»š","çˆ¬","æ€¼","æ·¦","å¦ˆ","çˆ¹","çˆ·","å‚»é€¼","åƒåœ¾","åºŸç‰©","ç‹—å±","ç‹—å±","æ‰¯æ·¡","æ¶å¿ƒ","æ²™é›•"},
    pinyin_abbrev = {"sb","cnm","nmsl","tmd","wdnmd","mlgb","wqnmlgb"},
    leet_initial  = {"c4o","ca0","f**k","fuk","fk","sh1t","b1tch","bi7ch"},
    memes         = {"ğŸ’€","ğŸ¤¡","ğŸ¶","ğŸ‘½"},
}

local wordsTable = nil
do
    if WORDS_TABLE_URL ~= "" then
        local mod, err = safeLoadFromUrl(WORDS_TABLE_URL)
        if type(mod)=="table" then wordsTable = mod end
    end
    if not wordsTable then wordsTable = FALLBACK_WORDS end
end

local totalWordCount = 0
do
    for _,list in pairs(wordsTable) do
        if type(list)=="table" then totalWordCount += #list end
    end
end

-- ===== Detector optional =====
local Detector = nil
local det = nil
local detectorStatus = "OFF"
local droppedWords = 0
do
    local mod, err = safeLoadFromUrl(DETECTOR_URL)
    if type(mod)=="table" and type(mod.new)=="function" and type(mod.scan)=="function" then
        Detector = mod
    end
end

if Detector then
    wordsTable, droppedWords = sanitizeWordsTable(wordsTable)
    totalWordCount = 0
    for _,list in pairs(wordsTable) do if type(list)=="table" then totalWordCount += #list end end

    local ok, inst = pcall(function() return Detector.new(wordsTable) end)
    if ok then
        det = inst
        detectorStatus = "ON"
    else
        det = nil
        detectorStatus = "OFF"
    end
end

local function scanDetector(msg)
    if not det then return false, 0 end
    msg = sanitizeUtf8(msg)
    local ok, r = pcall(function() return det:scan(msg) end)
    if ok and type(r)=="table" then
        return r.hit==true, nz(r.score,0)
    end
    return false, 0
end

-- ===== State =====
local state = {
    history = {},
    renderQueue = {},
    mutedPlayers = {},
    isSaving = false,

    startTime = os.time(),
    uiVisible = true,
    isCollapsed = false,

    pinEnabled = false,
    pinned = "BR",

    fontSize = Config.FontSize,
    width = Config.DefaultWidth,
    height = Config.DefaultHeight,
    capturePaused = false,
}

-- ===== Window buffer =====
local Window = { items = {} } -- {t, meta}

local function windowPrune(nowT)
    local cutoff = nowT - Config.WindowSeconds
    while #Window.items > 0 and Window.items[1].t < cutoff do table.remove(Window.items, 1) end
    while #Window.items > Config.WindowMaxMessages do table.remove(Window.items, 1) end
end

local function windowAdd(meta)
    local nowT = os.time()
    Window.items[#Window.items+1] = {t=nowT, meta=meta}
    windowPrune(nowT)
end

-- ===== Swear detection (FIXED: # always counts) =====
local function fallbackHit(msg)
    local m = string.lower(msg)
    for _,list in pairs(wordsTable) do
        if type(list)=="table" then
            for i=1,#list do
                local w = list[i]
                if type(w)=="string" and w~="" then
                    if m:find(string.lower(w),1,true) then return true end
                end
            end
        end
    end
    return false
end

local function analyzeMsg(msg)
    msg = tostring(msg or "")
    local hash = select(2, msg:gsub("#",""))
    local ex = select(2, msg:gsub("!","")) + select(2, msg:gsub("ï¼",""))
    local qu = select(2, msg:gsub("%?","")) + select(2, msg:gsub("ï¼Ÿ",""))

    if hash > 0 then
        return {swear=true, detScore=0, hash=hash, ex=ex, qu=qu}
    end

    local hit, score = scanDetector(msg)
    if hit then
        return {swear=true, detScore=score, hash=0, ex=ex, qu=qu}
    end

    if fallbackHit(msg) then
        return {swear=true, detScore=0, hash=0, ex=ex, qu=qu}
    end

    return {swear=false, detScore=0, hash=0, ex=ex, qu=qu}
end

local function computeStats()
    local nowT=os.time()
    windowPrune(nowT)
    local n=#Window.items
    if n<2 then return 0,0,0.0,0 end

    local swear=0
    local detSum,hashSum,exSum,quSum=0,0,0,0
    for i=1,n do
        local a=Window.items[i].meta
        if a.swear then swear+=1 end
        detSum += a.detScore
        hashSum += a.hash
        exSum += a.ex
        quSum += a.qu
    end

    local swearPct = math.floor((swear/n)*100)
    local span = math.max(1, Window.items[n].t - Window.items[1].t)
    local mps = n/span

    local burst=0
    do
        local t0=Window.items[n].t
        local c=0
        for i=n,1,-1 do
            if (t0-Window.items[i].t) <= Config.BurstSeconds then c+=1 else break end
        end
        burst=c
    end

    local score=0
    score += clamp((swear/n)*120,0,60)
    score += clamp((mps/1.8)*12,0,12)
    score += clamp((burst/7)*8,0,8)
    score += clamp(((exSum+quSum)/n)*2.2,0,10)
    score += clamp((hashSum/n)*4.0,0,10)
    score += clamp(((detSum/n)/10)*4,0,4)

    return math.floor(clamp(score,0,100)), swearPct, mps, burst
end

local function getLevel(v)
    if v < 20 then return "ğŸ•Šï¸ å’Œå¹³é¸½", Color3.fromRGB(100,255,100) end
    if v < 40 then return "ğŸ˜ èŒæ–°", Color3.fromRGB(200,255,100) end
    if v < 60 then return "ğŸ˜¤ æš´èºè€å“¥", Color3.fromRGB(255,200,100) end
    if v < 80 then return "ğŸ¤¬ è´´å§æˆ˜ç¥", Color3.fromRGB(255,100,100) end
    return "ğŸ’€ ç‹‚æš´ã®ç¥", Color3.fromRGB(255,50,50)
end

-- ===== UI =====
local UI = {filterText="", panelPeople=nil, peopleList=nil, peopleSearch=nil}
local function uiAlive() return UI.gui and UI.main and UI.main.Parent ~= nil end

local sys -- forward declareï¼Œé¿å…åå•å›è°ƒé—­åŒ…æå‰å¼•ç”¨ä¸ºç©º

local function categoryAllowed(cat)
    if cat == "CHAT" then return CategoryFilter.showCHAT end
    if not CategoryFilter.showSYSTEM then return false end
    return CategoryFilter[cat] ~= false
end

local function shouldShowEntry(e)
    if not e then return false end
    if not categoryAllowed(e.cat) then return false end
    if UI.filterText == "" then return true end
    return string.find(string.lower(e.text), UI.filterText, 1, true) ~= nil
end

local function rebuildPeopleList()
    if not uiAlive() or not UI.peopleList then return end
    UI.peopleList:ClearAllChildren()

    local layout=Instance.new("UIListLayout")
    layout.Padding=UDim.new(0,6)
    layout.SortOrder=Enum.SortOrder.LayoutOrder
    layout.Parent=UI.peopleList

    local kw = ""
    if UI.peopleSearch and type(UI.peopleSearch.Text)=="string" then
        kw = string.lower(UI.peopleSearch.Text)
    end

    local names = {}
    for _,p in ipairs(Players:GetPlayers()) do
        if p ~= lp then
            if kw=="" or string.find(string.lower(p.Name), kw, 1, true) then
                names[#names+1]=p.Name
            end
        end
    end
    table.sort(names)

    if #names == 0 then
        local tip=Instance.new("TextLabel")
        tip.Size=UDim2.new(1,-10,0,28)
        tip.BackgroundTransparency=1
        tip.Text=(kw=="" and "æš‚æ— å…¶ä»–ç©å®¶" or "æ²¡æœ‰åŒ¹é…ç©å®¶")
        tip.TextColor3=Config.Colors.Dim
        tip.Font=Enum.Font.Gotham
        tip.TextSize=13
        tip.Parent=UI.peopleList
        return
    end

    for i=1,#names do
        local name=names[i]
        local muted = state.mutedPlayers[name]==true
        local b=Instance.new("TextButton")
        b.Size=UDim2.new(1,-10,0,28)
        b.BorderSizePixel=0
        b.BackgroundTransparency=0.12
        b.BackgroundColor3 = muted and Config.Colors.Danger or Config.Colors.Secondary
        b.TextColor3 = Color3.new(0,0,0)
        b.Font=Enum.Font.GothamBold
        b.TextSize=13
        b.Text=(muted and "ğŸ”‡ " or "ğŸ”Š ")..name
        b.Parent=UI.peopleList
        makeRound(b, 8)
        b.MouseButton1Click:Connect(function()
            state.mutedPlayers[name] = not (state.mutedPlayers[name] == true)
            if sys then
                sys((state.mutedPlayers[name] and "ğŸ”‡ å·²é™éŸ³ï¼š" or "ğŸ”Š å·²å–æ¶ˆé™éŸ³ï¼š")..name, "SYS_HINT")
            end
            rebuildPeopleList()
            UI.renderAll()
        end)
    end
end

local function pushHistory(line)
    state.history[#state.history+1] = line
    if #state.history > Config.MaxHistory then table.remove(state.history,1) end
end

local function pushRender(entry)
    state.renderQueue[#state.renderQueue+1] = entry
    if #state.renderQueue > Config.RenderQueueMax then table.remove(state.renderQueue,1) end
end

local function addLine(raw, cat, color)
    local line = ("[%s] %s"):format(nowStr(), raw)
    pushHistory(line)
    pushRender({text=line, cat=cat, color=color})

    if not uiAlive() or state.isCollapsed then return end
    if not shouldShowEntry({text=line, cat=cat}) then
        if UI.filterText ~= "" or not categoryAllowed(cat) then UI.renderAll() end
        return
    end

    local lbl=Instance.new("TextLabel")
    lbl.BackgroundTransparency=1
    lbl.Size=UDim2.new(1,-10,0,0)
    lbl.AutomaticSize=Enum.AutomaticSize.Y
    lbl.TextWrapped=true
    lbl.TextXAlignment=Enum.TextXAlignment.Left
    lbl.TextYAlignment=Enum.TextYAlignment.Top
    lbl.Font=Enum.Font.SourceSans
    lbl.TextSize=state.fontSize
    lbl.TextColor3=color or Config.Colors.Text
    lbl.Text=line
    lbl.Parent=UI.scroll

    task.defer(function()
        if uiAlive() then UI.scroll.CanvasPosition=Vector2.new(0,1e9) end
    end)
end

sys = function(msg, sub)
    addLine("ğŸ§  ç³»ç»Ÿï¼š"..msg, sub or "SYS", Config.Colors.System)
end

function UI.renderAll()
    if not uiAlive() or state.isCollapsed then return end
    for _,c in ipairs(UI.scroll:GetChildren()) do
        if c:IsA("TextLabel") or c:IsA("UIListLayout") then c:Destroy() end
    end
    local layout=Instance.new("UIListLayout")
    layout.Padding=UDim.new(0,4)
    layout.SortOrder=Enum.SortOrder.LayoutOrder
    layout.Parent=UI.scroll
    layout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
        if uiAlive() then UI.scroll.CanvasSize=UDim2.new(0,0,0,layout.AbsoluteContentSize.Y+10) end
    end)

    local shown=0
    local start=math.max(1,#state.renderQueue-Config.RenderQueueMax+1)
    for i=start,#state.renderQueue do
        local e=state.renderQueue[i]
        if e then
            if shouldShowEntry(e) then
                local lbl=Instance.new("TextLabel")
                lbl.BackgroundTransparency=1
                lbl.Size=UDim2.new(1,-10,0,0)
                lbl.AutomaticSize=Enum.AutomaticSize.Y
                lbl.TextWrapped=true
                lbl.TextXAlignment=Enum.TextXAlignment.Left
                lbl.TextYAlignment=Enum.TextYAlignment.Top
                lbl.Font=Enum.Font.SourceSans
                lbl.TextSize=state.fontSize
                lbl.TextColor3=e.color or Config.Colors.Text
                lbl.Text=e.text
                lbl.Parent=UI.scroll
                shown += 1
                if shown>=Config.MaxRender then break end
            end
        end
    end
    task.defer(function()
        if uiAlive() then UI.scroll.CanvasPosition=Vector2.new(0,1e9) end
    end)
end

local function setPinnedIfEnabled()
    if not uiAlive() or not state.pinEnabled then return end
    local pad=10
    local w=state.width
    local h=state.isCollapsed and Config.CollapsedHeight or state.height
    if state.pinned=="BR" then UI.main.Position=UDim2.new(1,-w-pad,1,-h-pad)
    elseif state.pinned=="TR" then UI.main.Position=UDim2.new(1,-w-pad,0,pad)
    elseif state.pinned=="BL" then UI.main.Position=UDim2.new(0,pad,1,-h-pad)
    else UI.main.Position=UDim2.new(0,pad,0,pad) end
end

local function applyCollapsed()
    if not uiAlive() then return end
    if state.isCollapsed then
        tween(UI.main,0.22,{Size=UDim2.new(0,state.width,0,Config.CollapsedHeight)})
        UI.scroll.Visible=false
        UI.bar.Visible=false
        UI.handle.Visible=false
        UI.btnFold.Text="â–²"
        if UI.panelPeople then UI.panelPeople.Visible=false end
    else
        tween(UI.main,0.22,{Size=UDim2.new(0,state.width,0,state.height)})
        UI.scroll.Visible=true
        UI.bar.Visible=true
        UI.handle.Visible=true
        UI.btnFold.Text="â–¼"
        UI.renderAll()
    end
    setPinnedIfEnabled()
end

local function updateInfo()
    if not uiAlive() then return end
    local bz, swearPct, mps, burst = computeStats()
    local lvl,col=getLevel(bz)
    local rt=os.difftime(os.time(), state.startTime)
    UI.info.Text = ("ğŸ‘¥%d | %s %d%% | ğŸ¤¬%d%% | âš¡%.2f/s | ğŸ’¥%d | ğŸ“š%d | Detector:%s | %s")
        :format(#Players:GetPlayers(), lvl, bz, swearPct, mps, burst, totalWordCount, detectorStatus, state.capturePaused and "â¸æš‚åœ" or "â–¶è®°å½•")
    UI.info.TextColor3 = col
end

-- ===== save/copy =====
local function buildSave()
    local bz, swearPct, mps, burst = computeStats()
    local lvl = select(1,getLevel(bz))
    local out={}
    out[#out+1]="â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    out[#out+1]="â•‘ è´´å§ç‹‚æš´èŠå¤©è®°å½• "..nowStr()
    out[#out+1]="â•‘ ç‰ˆæœ¬ï¼š"..Config.Version
    out[#out+1]="â•‘ ç©å®¶ï¼š"..lp.Name
    out[#out+1]=("â•‘ Detectorï¼š%s | å­—åº“è¯æ•°ï¼š%d | UTF8ä¸¢å¼ƒï¼š%d"):format(detectorStatus,totalWordCount,droppedWords)
    out[#out+1]=("â•‘ è¿‘çª—ï¼šç‹‚æš´=%d%%(%s) | è„è¯ç‡=%d%% | %.2f msg/s | burst=%d"):format(bz,lvl,swearPct,mps,burst)
    out[#out+1]="â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    out[#out+1]=""
    for i=1,#state.history do out[#out+1]=state.history[i] end
    return table.concat(out,"\n")
end

local function saveAsync(cb)
    if state.isSaving then if cb then cb(false,"saving") end return end
    state.isSaving=true
    task.spawn(function()
        local timeout=false
        task.spawn(function() task.wait(Config.SaveTimeout); timeout=true end)
        local ok, err = pcall(function()
            local content=buildSave()
            if writefile then
                writefile(Config.FileName, content)
                writefile("./"..Config.FileName, content)
            end
        end)
        state.isSaving=false
        if timeout then if cb then cb(false,"timeout") end return end
        if cb then cb(ok, err) end
    end)
end

-- ===== Build UI (optimized layout) =====
local function buildUI()
    local old=pg:FindFirstChild("ChatLoggerGUI")
    if old then old:Destroy() end

    local gui=Instance.new("ScreenGui")
    gui.Name="ChatLoggerGUI"
    gui.ResetOnSpawn=false
    gui.Parent=pg
    UI.gui=gui

    local main=Instance.new("Frame")
    main.Size=UDim2.new(0,state.width,0,state.height)
    main.Position=UDim2.new(0,20,0,100)
    main.BackgroundColor3=Config.Colors.Background
    main.BackgroundTransparency=0.08
    main.BorderSizePixel=0
    main.ClipsDescendants=true
    main.Active=true
    main.Parent=gui
    makeRound(main, Config.CornerRadius)
    UI.main=main

    local stroke=Instance.new("UIStroke")
    stroke.Thickness=2
    stroke.Color=Config.Colors.Primary
    stroke.Transparency=0.15
    stroke.Parent=main

    local titleBar=Instance.new("Frame")
    titleBar.Size=UDim2.new(1,0,0,86)
    titleBar.BackgroundColor3=Config.Colors.Primary
    titleBar.BackgroundTransparency=0.22
    titleBar.BorderSizePixel=0
    titleBar.Parent=main
    makeRound(titleBar, Config.CornerRadius-2)
    UI.titleBar=titleBar

    local title=Instance.new("TextLabel")
    title.BackgroundTransparency=1
    title.Size=UDim2.new(1,-12,0,40)
    title.Position=UDim2.new(0,12,0,0)
    title.TextXAlignment=Enum.TextXAlignment.Left
    title.Font=Enum.Font.GothamBold
    title.TextSize=state.fontSize+3
    title.TextColor3=Color3.new(1,1,1)
    title.Text="ğŸ’€ è´´å§ç‹‚æš´è®°å½•å™¨ "..Config.Version
    title.Parent=titleBar

    -- right buttons with layout (no overlap)
    local right=Instance.new("Frame")
    right.BackgroundTransparency=1
    right.Size=UDim2.new(0, 220, 0, 40)
    right.Position=UDim2.new(1, -230, 0, 0)
    right.Parent=titleBar

    local rl=Instance.new("UIListLayout")
    rl.FillDirection=Enum.FillDirection.Horizontal
    rl.HorizontalAlignment=Enum.HorizontalAlignment.Right
    rl.VerticalAlignment=Enum.VerticalAlignment.Center
    rl.Padding=UDim.new(0,6)
    rl.Parent=right

    local function topBtn(text,bg,tc)
        local b=Instance.new("TextButton")
        b.Size=UDim2.new(0,40,0,40)
        b.BackgroundColor3=bg
        b.BackgroundTransparency=0.2
        b.BorderSizePixel=0
        b.Text=text
        b.TextSize=20
        b.Font=Enum.Font.GothamBold
        b.TextColor3=tc or Color3.new(0,0,0)
        b.Parent=right
        makeRound(b, 12)
        return b
    end

    local btnHide = topBtn("âœ–", Color3.fromRGB(255,255,255), Color3.new(0,0,0))
    UI.btnFold = topBtn("â–¼", Color3.fromRGB(255,255,255), Color3.new(0,0,0))

    local search=Instance.new("TextBox")
    search.Size=UDim2.new(0,200,0,28)
    search.Position=UDim2.new(1,-230-210,0,6)
    search.BackgroundColor3=Color3.fromRGB(0,0,0)
    search.BackgroundTransparency=0.35
    search.TextColor3=Color3.new(1,1,1)
    search.PlaceholderText="ğŸ” æœç´¢è¿‡æ»¤..."
    search.PlaceholderColor3=Color3.fromRGB(200,200,200)
    search.Text=""
    search.ClearTextOnFocus=false
    search.Font=Enum.Font.SourceSans
    search.TextSize=14
    search.BorderSizePixel=0
    search.Parent=titleBar
    makeRound(search, 10)
    UI.search=search

    local chipRow=Instance.new("Frame")
    chipRow.Size=UDim2.new(1,-20,0,34)
    chipRow.Position=UDim2.new(0,10,0,46)
    chipRow.BackgroundTransparency=1
    chipRow.Parent=titleBar

    local function capsule(x,text)
        local b=Instance.new("TextButton")
        b.Size=UDim2.new(0,90,0,26)
        b.Position=UDim2.new(0,x,0,4)
        b.BackgroundColor3=Color3.fromRGB(0,0,0)
        b.BackgroundTransparency=0.55
        b.BorderSizePixel=0
        b.Text=text
        b.TextColor3=Color3.new(1,1,1)
        b.TextSize=13
        b.Font=Enum.Font.GothamBold
        b.Parent=chipRow
        local cr=Instance.new("UICorner"); cr.CornerRadius=UDim.new(0,999); cr.Parent=b
        return b
    end
    local chipChat = capsule(0,"ğŸ’¬ èŠå¤©")
    local chipSys = capsule(98,"ğŸ§  ç³»ç»Ÿ")

    local function refreshChips()
        chipChat.BackgroundTransparency = CategoryFilter.showCHAT and 0.25 or 0.7
        chipSys.BackgroundTransparency = CategoryFilter.showSYSTEM and 0.25 or 0.7
    end
    refreshChips()

    chipChat.MouseButton1Click:Connect(function()
        CategoryFilter.showCHAT = not CategoryFilter.showCHAT
        refreshChips()
        UI.renderAll()
    end)
    chipSys.MouseButton1Click:Connect(function()
        CategoryFilter.showSYSTEM = not CategoryFilter.showSYSTEM
        refreshChips()
        UI.renderAll()
    end)

    local scroll=Instance.new("ScrollingFrame")
    scroll.Size=UDim2.new(1,-20,1,-210)
    scroll.Position=UDim2.new(0,10,0,94)
    scroll.BackgroundColor3=Color3.new(0,0,0)
    scroll.BackgroundTransparency=0.45
    scroll.BorderSizePixel=0
    scroll.ScrollBarThickness=8
    scroll.ScrollBarImageColor3=Config.Colors.Secondary
    scroll.Parent=main
    makeRound(scroll, 12)
    UI.scroll=scroll

    local layout=Instance.new("UIListLayout")
    layout.Padding=UDim.new(0,4)
    layout.SortOrder=Enum.SortOrder.LayoutOrder
    layout.Parent=scroll
    layout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
        if uiAlive() then scroll.CanvasSize=UDim2.new(0,0,0,layout.AbsoluteContentSize.Y+10) end
    end)

    local bar=Instance.new("Frame")
    bar.Size=UDim2.new(1,-20,0,104)
    bar.Position=UDim2.new(0,10,1,-140)
    bar.BackgroundTransparency=1
    bar.Parent=main
    UI.bar=bar

    local barPad=Instance.new("UIPadding")
    barPad.PaddingLeft=UDim.new(0,2)
    barPad.PaddingTop=UDim.new(0,2)
    barPad.Parent=bar

    local grid=Instance.new("UIGridLayout")
    grid.CellPadding=UDim2.new(0,8,0,8)
    grid.CellSize=UDim2.new(0,(state.width-52)/5,0,42)
    grid.Parent=bar

    local function mkBtn(text,bg)
        local b=Instance.new("TextButton")
        b.BackgroundColor3=bg
        b.BackgroundTransparency=0.12
        b.BorderSizePixel=0
        b.Text=text
        b.TextColor3=Color3.new(1,1,1)
        b.TextSize=state.fontSize-2
        b.Font=Enum.Font.GothamBold
        b.Parent=bar
        makeRound(b, 10)
        return b
    end

    local bSave  = mkBtn("ğŸ’¾ä¿å­˜", Config.Colors.Success)
    local bExport= mkBtn("ğŸ“¤å¯¼å‡º", Color3.fromRGB(0,150,255))
    local bCopy  = mkBtn("ğŸ“‹å¤åˆ¶", Color3.fromRGB(120,120,120))
    local bStats = mkBtn("ğŸ“Šç»Ÿè®¡", Color3.fromRGB(150,0,255))
    local bPeople= mkBtn("ğŸ‘¥åå•", Color3.fromRGB(0,200,200))

    local bFont  = mkBtn("ğŸ”¤å­—ä½“", Color3.fromRGB(90,90,90))
    local bClear = mkBtn("ğŸ—‘ï¸æ¸…ç©º", Color3.fromRGB(255,100,0))
    local bPin   = mkBtn("ğŸ“Œç½®é¡¶", Color3.fromRGB(200,0,200))
    local bPause = mkBtn("â¸è®°å½•", Color3.fromRGB(80,80,80))
    local bClose = mkBtn("â»å…³é—­", Config.Colors.Danger)

    local info=Instance.new("TextLabel")
    info.Size=UDim2.new(1,-20,0,22)
    info.Position=UDim2.new(0,10,1,-28)
    info.BackgroundTransparency=0.2
    info.BackgroundColor3=Color3.fromRGB(0,0,0)
    info.TextXAlignment=Enum.TextXAlignment.Left
    info.Font=Enum.Font.SourceSansBold
    info.TextSize=state.fontSize-4
    info.TextColor3=Config.Colors.Secondary
    info.Parent=main
    makeRound(info, 8)
    UI.info=info

    local handle=Instance.new("Frame")
    handle.Size=UDim2.new(0,20,0,20)
    handle.Position=UDim2.new(1,-20,1,-20)
    handle.BackgroundColor3=Config.Colors.Secondary
    handle.BackgroundTransparency=0.45
    handle.BorderSizePixel=0
    handle.Parent=main
    makeRound(handle, 8)
    UI.handle=handle

    local panelPeople=Instance.new("Frame")
    panelPeople.Size=UDim2.new(0,260,0,300)
    panelPeople.Position=UDim2.new(1,-240,0,94)
    panelPeople.BackgroundColor3=Config.Colors.Panel
    panelPeople.BackgroundTransparency=0.1
    panelPeople.BorderSizePixel=0
    panelPeople.Visible=false
    panelPeople.Parent=main
    makeRound(panelPeople, 12)
    UI.panelPeople=panelPeople

    local pplTitle=Instance.new("TextLabel")
    pplTitle.Size=UDim2.new(1,0,0,30)
    pplTitle.BackgroundColor3=Color3.fromRGB(0,200,200)
    pplTitle.BackgroundTransparency=0.25
    pplTitle.BorderSizePixel=0
    pplTitle.Font=Enum.Font.GothamBold
    pplTitle.TextSize=13
    pplTitle.TextColor3=Color3.new(0,0,0)
    pplTitle.Text="ğŸ‘¥ åå•ï¼ˆç‚¹åé™éŸ³ï¼‰"
    pplTitle.Parent=panelPeople
    makeRound(pplTitle, 10)

    local pplToolbar=Instance.new("Frame")
    pplToolbar.Size=UDim2.new(1,-10,0,54)
    pplToolbar.Position=UDim2.new(0,5,0,34)
    pplToolbar.BackgroundTransparency=1
    pplToolbar.Parent=panelPeople

    local pplSearch=Instance.new("TextBox")
    pplSearch.Size=UDim2.new(1,0,0,24)
    pplSearch.Position=UDim2.new(0,0,0,0)
    pplSearch.BackgroundColor3=Color3.fromRGB(0,0,0)
    pplSearch.BackgroundTransparency=0.3
    pplSearch.TextColor3=Color3.new(1,1,1)
    pplSearch.PlaceholderText="æœç´¢ç©å®¶å..."
    pplSearch.Text=""
    pplSearch.ClearTextOnFocus=false
    pplSearch.Font=Enum.Font.SourceSans
    pplSearch.TextSize=14
    pplSearch.BorderSizePixel=0
    pplSearch.Parent=pplToolbar
    makeRound(pplSearch, 8)
    UI.peopleSearch=pplSearch

    local btnMuteAll=Instance.new("TextButton")
    btnMuteAll.Size=UDim2.new(0.49,0,0,24)
    btnMuteAll.Position=UDim2.new(0,0,0,28)
    btnMuteAll.BackgroundColor3=Config.Colors.Danger
    btnMuteAll.BackgroundTransparency=0.15
    btnMuteAll.Text="å…¨é™éŸ³"
    btnMuteAll.TextColor3=Color3.new(1,1,1)
    btnMuteAll.Font=Enum.Font.GothamBold
    btnMuteAll.TextSize=12
    btnMuteAll.BorderSizePixel=0
    btnMuteAll.Parent=pplToolbar
    makeRound(btnMuteAll, 8)

    local btnUnmuteAll=Instance.new("TextButton")
    btnUnmuteAll.Size=UDim2.new(0.49,0,0,24)
    btnUnmuteAll.Position=UDim2.new(0.51,0,0,28)
    btnUnmuteAll.BackgroundColor3=Config.Colors.Secondary
    btnUnmuteAll.BackgroundTransparency=0.15
    btnUnmuteAll.Text="å…¨å–æ¶ˆ"
    btnUnmuteAll.TextColor3=Color3.new(0,0,0)
    btnUnmuteAll.Font=Enum.Font.GothamBold
    btnUnmuteAll.TextSize=12
    btnUnmuteAll.BorderSizePixel=0
    btnUnmuteAll.Parent=pplToolbar
    makeRound(btnUnmuteAll, 8)

    local pplList=Instance.new("ScrollingFrame")
    pplList.Size=UDim2.new(1,-10,1,-94)
    pplList.Position=UDim2.new(0,5,0,90)
    pplList.BackgroundTransparency=1
    pplList.BorderSizePixel=0
    pplList.ScrollBarThickness=6
    pplList.CanvasSize=UDim2.new(0,0,0,0)
    pplList.AutomaticCanvasSize=Enum.AutomaticSize.Y
    pplList.Parent=panelPeople
    makeRound(pplList, 8)
    UI.peopleList=pplList

    -- events
    search:GetPropertyChangedSignal("Text"):Connect(function()
        UI.filterText = string.lower(search.Text or "")
        UI.renderAll()
    end)

    if UI.peopleSearch then
        UI.peopleSearch:GetPropertyChangedSignal("Text"):Connect(function()
            if UI.panelPeople and UI.panelPeople.Visible then rebuildPeopleList() end
        end)
    end

    if btnMuteAll then
        btnMuteAll.MouseButton1Click:Connect(function()
            for _,p in ipairs(Players:GetPlayers()) do
                if p ~= lp then state.mutedPlayers[p.Name] = true end
            end
            sys("ğŸ”‡ å·²å…¨ä½“é™éŸ³", "SYS_HINT")
            rebuildPeopleList(); UI.renderAll()
        end)
    end

    if btnUnmuteAll then
        btnUnmuteAll.MouseButton1Click:Connect(function()
            state.mutedPlayers = {}
            sys("ğŸ”Š å·²å–æ¶ˆå…¨ä½“é™éŸ³", "SYS_HINT")
            rebuildPeopleList(); UI.renderAll()
        end)
    end

    btnHide.MouseButton1Click:Connect(function()
        main.Visible = not main.Visible
        btnHide.Text = main.Visible and "âœ–" or "â—‰"
    end)

    UI.btnFold.MouseButton1Click:Connect(function()
        state.isCollapsed = not state.isCollapsed
        applyCollapsed()
    end)

    bPause.MouseButton1Click:Connect(function()
        state.capturePaused = not state.capturePaused
        bPause.Text = state.capturePaused and "â–¶ç»§ç»­" or "â¸è®°å½•"
        bPause.BackgroundColor3 = state.capturePaused and Color3.fromRGB(120,120,120) or Color3.fromRGB(80,80,80)
        sys(state.capturePaused and "å·²æš‚åœèŠå¤©æŠ“å–ï¼ˆä»…åœæ­¢æ–°å¢èŠå¤©å…¥åº“ï¼‰" or "å·²æ¢å¤èŠå¤©æŠ“å–", "SYS_HINT")
        updateInfo()
    end)

    bStats.MouseButton1Click:Connect(function()
        local bz,swearPct,mps,burst = computeStats()
        local lvl=select(1,getLevel(bz))
        sys(("è¿‘çª—ï¼š%d%%(%s) | è„è¯ç‡=%d%% | %.2f/s | burst=%d | Detector=%s")
            :format(bz,lvl,swearPct,mps,burst,detectorStatus), "SYS_STATS")
    end)

    bSave.MouseButton1Click:Connect(function()
        saveAsync(function(ok,err)
            sys(ok and "ä¿å­˜æˆåŠŸ" or ("ä¿å­˜å¤±è´¥ï¼š"..tostring(err)), "SYS_SAVE")
        end)
    end)

    bExport.MouseButton1Click:Connect(function()
        saveAsync(function(ok,err)
            sys(ok and "å¯¼å‡ºæˆåŠŸï¼ˆå†™å…¥æ–‡ä»¶ï¼‰" or ("å¯¼å‡ºå¤±è´¥ï¼š"..tostring(err)), "SYS_EXPORT")
        end)
    end)

    bCopy.MouseButton1Click:Connect(function()
        local all = table.concat(state.history,"\n")
        if setclipboard then
            pcall(function() setclipboard(all) end)
            sys(("å·²å¤åˆ¶ï¼ˆ%dæ¡ï¼‰"):format(#state.history),"SYS_EXPORT")
        else
            sys("ç¯å¢ƒä¸æ”¯æŒ setclipboard","SYS_EXPORT")
        end
    end)
    bPeople.MouseButton1Click:Connect(function()
        if not UI.panelPeople then return end
        UI.panelPeople.Visible = not UI.panelPeople.Visible
        if UI.panelPeople.Visible then rebuildPeopleList() end
    end)

    bFont.MouseButton1Click:Connect(function()
        local sizes={14,18,22,26}
        local idx=1
        for i,s in ipairs(sizes) do if state.fontSize==s then idx=i break end end
        state.fontSize = sizes[idx%#sizes+1]
        sys("å­—ä½“å¤§å°="..tostring(state.fontSize),"SYS_HINT")
        UI.renderAll(); updateInfo()
    end)

    bClear.MouseButton1Click:Connect(function()
        state.history={}
        state.renderQueue={}
        Window.items={}
        sys("å·²æ¸…ç©º","SYS_HINT")
        UI.renderAll(); updateInfo()
    end)

    local pinCycle={"BR","TR","TL","BL"} local pi=1
    bPin.MouseButton1Click:Connect(function()
        pi = pi%#pinCycle + 1
        state.pinned = pinCycle[pi]
        state.pinEnabled = true
        setPinnedIfEnabled()
        sys("ğŸ“Œç½®é¡¶ï¼š"..state.pinned.."ï¼ˆæ‹–åŠ¨/ç¼©æ”¾ä¼šå–æ¶ˆï¼‰","SYS_HINT")
    end)

    bClose.MouseButton1Click:Connect(function()
        gui:Destroy()
    end)

    -- drag cancel pin
    local dragging=false
    local dragOffset=Vector2.new()
    titleBar.InputBegan:Connect(function(input)
        if input.UserInputType==Enum.UserInputType.MouseButton1 or input.UserInputType==Enum.UserInputType.Touch then
            dragging=true
            dragOffset=Vector2.new(input.Position.X-main.AbsolutePosition.X, input.Position.Y-main.AbsolutePosition.Y)
            state.pinEnabled=false
        end
    end)
    titleBar.InputEnded:Connect(function(input)
        if input.UserInputType==Enum.UserInputType.MouseButton1 or input.UserInputType==Enum.UserInputType.Touch then dragging=false end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if not dragging or not uiAlive() then return end
        if input.UserInputType==Enum.UserInputType.MouseMovement or input.UserInputType==Enum.UserInputType.Touch then
            main.Position=UDim2.new(0, input.Position.X-dragOffset.X, 0, input.Position.Y-dragOffset.Y)
        end
    end)

    -- resize cancel pin
    local resizing=false
    local rs=Vector2.new()
    local rsz=Vector2.new()
    handle.InputBegan:Connect(function(input)
        if state.isCollapsed then return end
        if input.UserInputType==Enum.UserInputType.MouseButton1 or input.UserInputType==Enum.UserInputType.Touch then
            resizing=true
            rs=Vector2.new(input.Position.X,input.Position.Y)
            rsz=Vector2.new(main.AbsoluteSize.X,main.AbsoluteSize.Y)
            state.pinEnabled=false
        end
    end)
    handle.InputEnded:Connect(function(input)
        if input.UserInputType==Enum.UserInputType.MouseButton1 or input.UserInputType==Enum.UserInputType.Touch then resizing=false end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if not resizing or state.isCollapsed or not uiAlive() then return end
        if input.UserInputType==Enum.UserInputType.MouseMovement or input.UserInputType==Enum.UserInputType.Touch then
            local d=Vector2.new(input.Position.X-rs.X, input.Position.Y-rs.Y)
            state.width = clamp(rsz.X+d.X, Config.MinWidth, Config.MaxWidth)
            state.height= clamp(rsz.Y+d.Y, Config.MinHeight, Config.MaxHeight)
            main.Size=UDim2.new(0,state.width,0,state.height)
            grid.CellSize=UDim2.new(0,(state.width-52)/5,0,42)
        end
    end)

    RunService.Heartbeat:Connect(function()
        if not uiAlive() then return end
        if UI.search then
            local show = (UI.main.AbsoluteSize.X >= Config.SearchHideWidth) and (not state.isCollapsed)
            UI.search.Visible = show
        end
    end)

    -- init
    sys(("å¯åŠ¨å®Œæˆï¼šDetector=%s | å­—åº“=%d | UTF8ä¸¢å¼ƒ=%d"):format(detectorStatus,totalWordCount,droppedWords),"SYS_START")
    sys("v1.1 æ–°å¢ï¼šğŸ‘¥åå•é¢æ¿ç‚¹åé™éŸ³ + â¸æš‚åœ/â–¶ç»§ç»­æŠ“å– + çª„å±è‡ªåŠ¨éšè—æœç´¢æ¡†", "SYS_START")
    sys("v1.1.1 çƒ­ä¿®ï¼šç§»é™¤ goto/label å†™æ³•ï¼Œä¿®å¤éƒ¨åˆ†ç¯å¢ƒæŠ¥é”™ Incomplete statement", "SYS_START")
    sys("v1.1.2 æ–°å¢ï¼šåå•æœç´¢ + å…¨é™éŸ³/å…¨å–æ¶ˆ + é™éŸ³é¢æ¿ç¨³å®šæ€§ä¿®å¤", "SYS_START")
    sys("v1.1.3 æ–°å¢ï¼šUIåœ†è§’ç¾åŒ– + æ›´èˆ’é€‚é—´è·æ’ç‰ˆ + æŒ‰é’®ç»Ÿä¸€é£æ ¼", "SYS_START")
    sys("v1.2.1 æ–°å¢ï¼šæ£€æµ‹å¼•æ“v5.1ï¼ˆè°éŸ³/å½¢è¿‘å­—/è¯­å¢ƒç™½åå•ï¼‰", "SYS_START")
    updateInfo()
    UI.renderAll()
end

buildUI()

-- ===== Chat hooks =====
local Dedup={}
local function passDedup(speaker,text)
    local t=os.clock()
    local k=tostring(speaker).."â”‚"..tostring(text)
    local last=Dedup[k]
    Dedup[k]=t

    if math.floor(t) % 3 == 0 then
        for dk,dt in pairs(Dedup) do
            if (t-dt) > Config.DedupTTL then Dedup[dk]=nil end
        end
    end

    return (not last) or ((t-last)>0.35)
end

local function onCaptured(speaker,text)
    if state.capturePaused then return end
    if type(text)~="string" or text=="" then return end
    if not passDedup(speaker,text) then return end
    local muted = state.mutedPlayers[speaker]==true
    addLine((speaker==lp.Name) and ("æˆ‘ï¼š"..text) or (tostring(speaker).."ï¼š"..text), "CHAT", muted and Config.Colors.Muted or Config.Colors.Text)
    windowAdd(analyzeMsg(text))
end

local function hookTCS()
    if not TextChatService then return false end
    local ok, ver = pcall(function() return TextChatService.ChatVersion end)
    if not ok or ver ~= Enum.ChatVersion.TextChatService then return false end
    if typeof(TextChatService.MessageReceived) ~= "RBXScriptSignal" then return false end

    TextChatService.MessageReceived:Connect(function(msg)
        local speaker="æœªçŸ¥"
        local text=""
        pcall(function()
            text = msg.Text or ""
            if msg.TextSource and msg.TextSource.UserId then
                local p=Players:GetPlayerByUserId(msg.TextSource.UserId)
                if p then speaker=p.Name end
            end
        end)
        onCaptured(speaker,text)
    end)
    sys("èŠå¤©æºï¼šTCS.MessageReceived âœ…","SYS_CHATFLOW")
    return true
end

local function hookDefault()
    local ev=ReplicatedStorage:FindFirstChild("DefaultChatSystemChatEvents")
    if not ev then return false end
    local r=ev:FindFirstChild("OnMessageDoneFiltering")
    if not r or not r:IsA("RemoteEvent") then return false end

    r.OnClientEvent:Connect(function(md)
        local speaker=(type(md)=="table" and (md.FromSpeaker or md.FromSpeakerName)) or "æœªçŸ¥"
        local text=(type(md)=="table" and (md.Message or md.MessageText)) or ""
        onCaptured(speaker, tostring(text or ""))
    end)
    sys("èŠå¤©æºï¼šDefaultChatEvents âœ…","SYS_CHATFLOW")
    return true
end

local function hookChatted()
    local function bind(p)
        p.Chatted:Connect(function(msg)
            onCaptured(p.Name, msg)
        end)
    end
    for _,p in ipairs(Players:GetPlayers()) do bind(p) end
    Players.PlayerAdded:Connect(bind)
    sys("èŠå¤©æºï¼šPlayer.Chatted âœ…","SYS_CHATFLOW")
    return true
end

hookTCS()
hookDefault()
hookChatted()

Players.PlayerAdded:Connect(function(p)
    if p ~= lp then sys(p.Name.." åŠ å…¥äº†æ¸¸æˆ","SYS_JOINLEAVE") end
    if UI.panelPeople and UI.panelPeople.Visible then rebuildPeopleList() end
end)
Players.PlayerRemoving:Connect(function(p)
    if p ~= lp then sys(p.Name.." ç¦»å¼€äº†æ¸¸æˆ","SYS_JOINLEAVE") end
    if UI.panelPeople and UI.panelPeople.Visible then rebuildPeopleList() end
end)

-- ticker
do
    local interval=1/Config.StatsUpdateHz
    local acc=0
    RunService.Heartbeat:Connect(function(dt)
        acc += dt
        if acc>=interval then acc=0; updateInfo() end
    end)
end

-- autosave
task.spawn(function()
    while true do
        task.wait(Config.AutoSaveInterval)
        if #state.history>0 and not state.isSaving then
            saveAsync(function(ok)
                if ok then sys("è‡ªåŠ¨ä¿å­˜å®Œæˆ","SYS_SAVE") end
            end)
        end
    end
end)
